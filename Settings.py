# ==============================================================================
# Проект: Бортовий Комп'ютер для Audi 80 B3 Monomotronic на Raspberry Pi Pico
# Файл: Settings.py
# Опис: Глобальний файл конфігурації. Містить усі налаштування, константи
#       та калібрувальні параметри, які можна змінити без редагування
#       основної логіки програми (main.py).
# Автор: tor4man66
# Дата оновлення: 2026-01-14
# ==============================================================================

# Використання micropython.const для оптимізації пам'яті та швидкості.
# Це перетворює змінні на константи часу компіляції.
from micropython import const

# ------------------------------------------------------------------------------
# 1. ПІНИ ПІДКЛЮЧЕННЯ (HARDWARE PINS)
#    Визначення GPIO пінів на Raspberry Pi Pico, до яких підключені
#    різні компоненти та датчики.
# ------------------------------------------------------------------------------
PIN_INJ = const(0)  # GPIO 0: Вхідний пін для сигналу з форсунки (injector pulse).
                    # Використовується для розрахунку RPM та витрати палива.
PIN_VSS = const(1)  # GPIO 1: Вхідний пін для сигналу з датчика швидкості (Vehicle Speed Sensor).
                    # Використовується для розрахунку пройденої відстані та швидкості.
PIN_I2C_SDA = const(4) # GPIO 4: Пін даних (SDA) для інтерфейсу I2C.
PIN_I2C_SCL = const(5) # GPIO 5: Пін тактування (SCL) для інтерфейсу I2C.
                       # I2C використовується для підключення OLED дисплея.
PIN_BUTTON_RESET = const(2) # GPIO 2: Вхідний пін для кнопки скидання показників TRIP та спец екрану
                            # та активації спеціального екрану.
PIN_SENSOR_BRAKE_FLUID = const(24) # GPIO 24: Вхідний пін для датчика рівня гальмівної рідини.
                                   # Зазвичай активний низький (0V) при низькому рівні.
PIN_SENSOR_OIL_PRESSURE_0_3 = const(7) # GPIO 7: Вхідний пін для датчика тиску мастила (0.3).
                                       # Активний низький (0V) при низькому тиску.
PIN_SENSOR_OVERHEAT_AND_LOW_COOLANT = const(8) # GPIO 8: Об'єднаний вхідний пін для датчиків перегріву двигуна
                                             # та низького рівня охолоджувальної рідини. Активний низький (0V) при проблемі.
PIN_SENSOR_OIL_PRESSURE_1_8 = const(10) # GPIO 10: Вхідний пін для датчика тиску мастила (1.8).
                                         # Активний низький (0V) при високому тиску (якщо перевищує норму) або
                                         # у разі несправності датчика.
PIN_SPEAKER = const(12) # GPIO 12: Вихідний пін для підключення динаміка або зумера для звукових сповіщень.
PIN_FUEL_LEVEL_ADC = const(28) # ADC 28: Аналоговий вхідний пін для датчика рівня палива.
                               # Це пін ADC2 на Raspberry Pi Pico.
PIN_ADC = const (26) # GPIO 26: Вхідний пін для ADC 12V.

# ------------------------------------------------------------------------------
# 2. КАЛІБРУВАННЯ ВИТРАТИ ПАЛИВА ТА ДАТЧИКІВ
#    Параметри, пов'язані з розрахунком витрати палива та калібруванням датчиків.
# ------------------------------------------------------------------------------
# Продуктивність форсунки в мл/хв. Це значення критично важливе для точного розрахунку витрати палива.
# Для Bosch 0 280 150 651 (типово для Monomotronic) при 1.3 бар - 813 мл/хв.
INJ_FLOW_RATE_ML_PER_MIN = const(813)

# Час "мертвої зони" (dead time) форсунки в мікросекундах. Це час, коли форсунка
# електрично активна, але механічно ще не відкрилася або вже закрилася.
# Віднімається від загальної тривалості імпульсу для точнішого розрахунку фактичного часу відкриття.
INJ_DEAD_TIME_US = const(150) # Мкс при 14.0В
INJ_VOLT_SENSITIVITY = 10 # Додаємо/віднімаємо мкс на кожен 1В відхилення

# Мінімальна тривалість імпульсу форсунки (ON-час) в мікросекундах.
# Імпульси, коротші за це значення, ігноруються як електричний шум.
MIN_INJ_PULSE_WIDTH_FILTER_US = const(500)

# Кількість імпульсів датчика швидкості (VSS) на 1 кілометр.
# Це значення залежить від типу датчика VSS, трансмісії та розміру коліс.
VSS_IMPULSES_PER_KM = const(4324)

# Час дебаунсу для IRQ датчика швидкості (VSS) в мікросекундах.
# Запобігає множинному спрацьовуванню переривання від одного імпульсу через шум.
VSS_DEBOUNCE_US = const(500)

# ------------------------------------------------------------------------------
# 3. НАЛАШТУВАННЯ ДАТЧИКА ПАЛИВА (ADC)
#    Параметри для калібрування аналогового датчика рівня палива.
# ------------------------------------------------------------------------------
# Діапазон сирих значень ADC (Analog-to-Digital Converter).
# Для Raspberry Pi Pico ADC має 12-бітну роздільну здатність (0-4095),
# але для Micropython часто використовується 16-бітне представлення (0-65535).
# Важливо: Об'єм бака Audi 80 B3 становить 68 літрів.
FUEL_TANK_CAPACITY_L = const(68)  # Об'єм бака Audi 80 B3

FUEL_ADC_MIN_RAW = const(200) # Мінімальне сире значення ADC для 0% палива (200).
FUEL_ADC_MAX_RAW = const(1950) # Максимальне сире значення ADC для 100% палива (1950).

# Параметри згладжування та обмеження швидкості зміни рівня палива.
FUEL_BUFFER_SIZE = const(16) # Кількість останніх значень ADC, що зберігаються в буфері для обчислення середнього
                             # значення. Більший буфер = сильніше згладжування, повільніша реакція.
FUEL_MAX_PERCENT_CHANGE_PER_SEC = const(10) # Максимально дозволена зміна рівня палива в % за секунду.
                                            # Захищає від різких стрибків показань через коливання палива в баку.

# Параметри гістерезису для активації/деактивації попередження "Мало палива".
# Гістерезис запобігає швидкому перемиканню попередження "ON/OFF" при коливанні рівня палива
# поблизу порогового значення.
FUEL_LOW_THRESHOLD_PERCENT = const(6) # Відсоток палива, при якому *активується* попередження "Мало палива" (прибл. 4 літри).
FUEL_HIGH_THRESHOLD_PERCENT = const(12) # Відсоток палива, при якому *деактивується* попередження "Мало палива" (прибл. 8 літрів).

# Тривалість відображення іконки "Мало палива" та повернення до головного екрану.
LOW_FUEL_DISPLAY_DURATION_MS = const(3000) # Тривалість (мс) відображення іконки "Мало палива" на екрані.
LOW_FUEL_MAIN_SCREEN_DURATION_MS = const(30000) # Тривалість (мс) відображення головного екрану, перш ніж
                                                # знову показати іконку "Мало палива" (якщо умова все ще активна).

# ------------------------------------------------------------------------------
# 4. НАЛАШТУВАННЯ ДИСПЛЕЯ ТА ТЕКСТУ (OLED SH1107)
#    Параметри, що керують відображенням інформації на OLED дисплеї.
# ------------------------------------------------------------------------------
I2C_FREQ = const(400000) # Частота шини I2C для OLED дисплея в Герцах (400 кГц - стандарт).
OLED_ADDR_HEX = const(0x3C) # Адреса OLED дисплея по I2C.
OLED_CONTRAST = const(0xFF) # Контраст OLED дисплея (0x00 - найменший, 0xFF - найбільший).

# Тривалість відображення початкових екранів при запуску системи.
STARTUP_OK_SCREEN_DURATION_SEC = const(3) # Тривалість (секунди) відображення екрану "STATUS OK" при запуску (якщо немає критичних помилок).
STARTUP_ERROR_SCREEN_DURATION_SEC = const(5) # Тривалість (секунди) відображення першої критичної помилки при запуску (якщо такі є).

# Налаштування згладжування миттєвої витрати палива на головному екрані.
MAIN_VAL_BUFFER_SIZE = const(3)  # Розмір буфера для згладжування показників L/H або L/100KM.
                                 # Більше значення = плавніші цифри, але повільніша реакція на зміну витрати.

# Основний показник (миттєва витрата L/H або L/100KM).
MAIN_VALUE_FONT_SIZE = const(3) # Розмір шрифту основного показника (кожен символ 8x8 пікселів розтягується в 8*SIZE x 8*SIZE).
                                # Наприклад, SIZE=3 дає символи 24x24 пікселі.
MAIN_VALUE_Y_POS = const(8) # Вертикальна позиція (Y-координата) основного показника на екрані.
MAIN_VALUE_X_OFFSET = const(-7) # Горизонтальне зміщення (X-координата) основного показника від центру.
                                # Позитивне значення - вправо, негативне - вліво.

# Одиниці виміру (L/100KM, L/H) для основного показника.
MAIN_UNIT_FONT_SIZE_X = const(1) # Горизонтальне розтягування шрифту для одиниць виміру.
MAIN_UNIT_FONT_SIZE_Y = const(2) # Вертикальне розтягування шрифту для одиниць виміру.
MAIN_UNIT_Y_OFFSET = const(18) # Вертикальне зміщення одиниць виміру від нижнього краю основного показника.

# Налаштування рамки навколо основного показника та одиниць.
MAIN_FRAME_PADDING_PX = const(4) # Відступ (в пікселях) рамки від найближчих елементів (тексту).
MAIN_FRAME_RADIUS_PX = const(2) # Радіус заокруглення кутів рамки (в пікселях).
                                 # Примітка: Поточна реалізація підтримує мінімальне заокруглення.

# Позиції для тексту статистики поїздок (TRIP та PERS).
TRIP_STAT_Y_POS = const(74) # Вертикальна позиція для рядка статистики поточної поїздки (TRIP).
PERS_STAT_Y_POS = const(96) # Вертикальна позиція для рядка загальної персистентної статистики (PERS).
STAT_TEXT_X_POS = const(9) # Горизонтальна позиція для початку тексту статистики.

# Ширина числових полів для форматування TRIP та PERS.
# Використовується для підтримки фіксованої ширини та запобігання "стрибкам" тексту при зміні значень.
TRIP_FUEL_DISPLAY_WIDTH = const(4) # Ширина поля для відображення літрів TRIP (наприклад, "XX.X").
TRIP_DISTANCE_DISPLAY_WIDTH = const(3) # Ширина поля для відображення кілометрів TRIP (наприклад, "XXX").
PERS_L100KM_DISPLAY_WIDTH = const(4) # Ширина поля для відображення середньої витрати PERS (наприклад, "XX.X").

# Екран аварійної помилки (відображається при критичних збоях програми).
LOOP_ERROR_TEXT_SIZE = const(1) # Розмір шрифту для тексту "LOOP ERR".
LOOP_ERROR_X_POS = const(25) # Горизонтальна позиція тексту "LOOP ERR".
LOOP_ERROR_Y_POS = const(50) # Вертикальна позиція тексту "LOOP ERR".

# Інтервал блимання для попереджень (мс). Використовується для візуальних ефектів.
BLINK_INTERVAL_MS = const(1000)

# Максимальне значення L/100KM, яке відображається.
# Якщо розраховане значення (для PERS або MAIN L/100KM) перевищує це,
# буде показано "----" або "-.--" замість чисел.
MAX_DISPLAY_L100KM_VALUE = const(99.9)

# ------------------------------------------------------------------------------
# 5. НАЛАШТУВАННЯ СПЕЦІАЛЬНОГО ЕКРАНУ (Швидкість, RPM, Паливо)
# ------------------------------------------------------------------------------
SPECIAL_SCREEN_DISPLAY_DURATION_MS = const(15000) # Тривалість (мс) відображення спеціального екрану.

# Налаштування шрифтів та позицій для елементів спеціального екрану.

SP_SCR_VOLTAGE_Y = const(3) # Y-координата для відображення напруги.
SP_SCR_VOLTAGE_X = const(34) # X-координата для відображення напруги.
SP_SCR_VOLTAGE_FONT_SIZE = const(2) # Розмір шрифту для напруги.

SP_SCR_SPEED_Y = const(23) # Y-координата для відображення швидкості.
SP_SCR_SPEED_X = const(18) # X-координата для відображення швидкості.
SP_SCR_SPEED_FONT_SIZE = const(2) # Розмір шрифту для швидкості.

SP_SCR_RPM_Y = const(43) # Y-координата для відображення RPM.
SP_SCR_RPM_X = const(0) # X-координата для відображення RPM.
SP_SCR_RPM_FONT_SIZE = const(2) # Розмір шрифту для RPM.

SP_SCR_INJ_Y = const(63) # Y-координата для відображення INJ.
SP_SCR_INJ_X = const(2) # X-координата для відображення INJ.
SP_SCR_INJ_FONT_SIZE = const(2) # Розмір шрифту для INJ.

SP_SCR_FUEL_Y = const(83) # Y-координата для відображення палива.
SP_SCR_FUEL_X = const(66) # X-координата для відображення палива.
SP_SCR_FUEL_FONT_SIZE = const(2) # Розмір шрифту для палива.

# ------------------------------------------------------------------------------
# 6. НАЛАШТУВАННЯ ЛОГІКИ ДВИГУНА, ПОМИЛОК ТА ЗВУКУ
#    Параметри, що керують поведінкою системи, пов'язаною з двигуном,
#    діагностикою та сповіщеннями.
# ------------------------------------------------------------------------------
# Загальний інтервал оновлення екрану та більшості розрахунків в основному циклі (в секундах).
UPDATE_INTERVAL_SEC = const(1)

# Час без імпульсів форсунки (мс), після якого двигун вважається заглушеним.
ENGINE_STOP_TIMEOUT_MS = const(2000) # 2 секунди.

# Затримка початку підрахунку палива та VSS після пуску двигуна (у секундах).
# Потрібно, щоб двигун стабілізувався після запуску.
WARMUP_DELAY_SEC = const(4)

# Затримка перед активацією помилки "Низький тиск масла" після запуску двигуна (мс).
# Дозволяє двигуну накачати тиск масла перед перевіркою.
OIL_CHECK_DELAY_MS = const(5000)

# Мінімальні оберти двигуна (RPM), які вважаються "стабільно працюючим двигуном".
# Нижче цього значення деякі показники (наприклад, накопичення палива) можуть бути тимчасово вимкнені.
MIN_RPM_FOR_STABLE_RUNNING = const(550)

# Мінімальні оберти двигуна (RPM) для перевірки датчика високого тиску мастила.
# Цей датчик зазвичай спрацьовує при певних оборотах.
MIN_RPM_FOR_HIGH_PRESSURE_CHECK = const(2000)

# Послідовність звукових сигналів тривоги: список кортежів (тривалість_мс, частота_Гц).
# Дозволяє створювати складні звукові патерни. Частота 0 Гц означає тишу.
ALARM_SEQUENCE = [\
    (1000, 1000), (1000, 0),    # 1 секунда звук (1000 Гц), 1 секунда тиша
    (1000, 1000), (1000, 0),    # Повтор
    (1000, 1000), (15000, 0)    # Повтор, потім довга пауза
]

# Інтервал перемикання між різними іконками помилок на екрані (мс).
ERROR_DISPLAY_CYCLE_MS = const(3000)

# Налаштування кнопки скидання TRIP та активації спеціального екрану.
BUTTON_DEBOUNCE_MS = const(200)     # Час дебаунсу (мс) для кнопки, щоб уникнути хибних спрацьовувань.
BUTTON_TRIP_RESET_HOLD_MS = const(2000) # Тривалість утримання (мс) кнопки для скидання TRIP.
BUTTON_SPECIAL_SCREEN_HOLD_MS = const(5000) # Тривалість утримання (мс) кнопки для активації спец. екрану.

# Налаштування звуку при скиданні TRIP.
BUTTON_TRIP_RESET_BEEP_FREQ = const(2000)       # Частота звукового сигналу (Гц).
BUTTON_TRIP_RESET_BEEP_DURATION_SEC = const(0.05) # Тривалість звукового сигналу (секунди).

# Налаштування подвійного звуку при активації спец. екрану.
BUTTON_SPECIAL_SCREEN_BEEP_FREQ_1 = const(1500) # Частота першого звуку (Гц).
BUTTON_SPECIAL_SCREEN_BEEP_DURATION_1 = const(0.1) # Тривалість першого звуку (секунди).
BUTTON_SPECIAL_SCREEN_BEEP_PAUSE_BETWEEN_SEC = const(0.05) # Пауза між звуками (секунди).
BUTTON_SPECIAL_SCREEN_BEEP_FREQ_2 = const(2500) # Частота другого звуку (Гц).
BUTTON_SPECIAL_SCREEN_BEEP_DURATION_2 = const(0.1) # Тривалість другого звуку (секунди).

# ------------------------------------------------------------------------------
# 7. КАЛІБРУВАННЯ RPM (ОБЕРТИ ДВИГУНА)
#    Детальні налаштування для точного розрахунку обертів двигуна.
# ------------------------------------------------------------------------------
# Базовий коефіцієнт для обчислення RPM.
# Це кількість мікросекунд в одній хвилині (60 секунд * 1 000 000 мікросекунд/секунду).
RPM_BASE_FACTOR = const(60_000_000)

# Кількість імпульсів форсунки на один оберт колінчастого валу двигуна.
# Для 4-циліндрового двигуна з Monomotronic, форсунка, як правило,
# спрацьовує один раз на оберт колінчастого валу (або 2 рази на повний цикл двигуна).
# Це значення є критичним для точного розрахунку RPM. Перевірте специфікацію вашого двигуна.
RPM_PULSES_PER_ENGINE_REVOLUTION = const(2)

# Мінімальний період між послідовними імпульсами форсунки (мкс), що вважається дійсним для розрахунку RPM.
# Якщо період коротший, це може бути шум або невірне зчитування на дуже високих обертах.
# Відповідає приблизно 8500 об/хв.
MIN_INJ_PERIOD_FOR_RPM_US = const(7000)

# Максимальний період між послідовними імпульсами форсунки (мкс), що вважається дійсним для розрахунку RPM.
# Якщо період довший, це може означати дуже низькі оберти (близькі до зупинки) або шум.
# Відповідає приблизно 500 об/хв.
MAX_INJ_PERIOD_FOR_RPM_US = const(120000)

# Діапазон обертів двигуна (RPM), які будуть відображатися на екрані.
# Значення поза цим діапазоном будуть показуватися як 0 RPM, щоб уникнути відображення нереалістичних даних.
MIN_DISPLAY_RPM = const(400)       # Мінімальні оберти для відображення.
MAX_DISPLAY_RPM = const(8500)      # Максимальні оберти для відображення.

# ------------------------------------------------------------------------------
# 8. НАЛАШТУВАННЯ СТАТИСТИКИ ТА ФАЙЛОВОЇ СИСТЕМИ
#    Параметри для керування збереженням даних поїздок та логікою відображення.
# ------------------------------------------------------------------------------
# Максимальні ліміти для накопичених даних поточної поїздки (TRIP).
# Після досягнення цих значень, лічильники TRIP автоматично скидаються.
MAX_TRIP_LITERS = const(99.9) # Максимальна кількість палива TRIP (99.9 L).
MAX_TRIP_DISTANCE = const(999) # Максимальна відстань TRIP (999 KM).

# Мінімальні умови для відображення показника L/100KM.
# Цей показник має сенс лише при певній швидкості та пройденій відстані.
MIN_SPEED_FOR_L100KM_KMH = const(10.0) # Мінімальна швидкість (км/год) для відображення L/100KM.
MIN_DISTANCE_FOR_L100KM_KM = const(0.1) # Мінімальна пройдена відстань (км) для відображення L/100KM.

# Поріг для визначення стаціонарного стану (L/H).
# Якщо витрата палива (в L/H) нижче цього порогу, замість числа буде показано "-.--".
STATIONARY_THRESHOLD = const(0.05)

# Налаштування для PERS (персистентна середня витрата та пробіг).
MIN_SPEED_FOR_PERS_COUNT_KMH = const(1.0) # Мінімальна швидкість (км/год), вище якої PERS накопичує паливо та відстань.
MIN_PERS_DISPLAY_DISTANCE_KM = const(0.1) # Мінімальна пройдена відстань (км), після якої PERS почне відображати L/100KM.

# Відстань (км) для автоматичного скидання лічильників PERS (повного пробігу).
# Це значення дозволяє автоматично "обнуляти" довгострокову статистику.
RESET_PERSISTENT_TRIP_DISTANCE_KM = const(5000)

# Імена файлів для збереження персистентних даних.
# Використання тимчасових та резервних файлів забезпечує атомарність збереження
# та захист від пошкодження даних у разі раптового відключення живлення.
TRIP_DATA_FILE = 'trip_data.txt'    # Основний файл для збереження даних поїздок.
TRIP_DATA_BACKUP = 'trip_data.bak'  # Резервний файл даних поїздок.
TRIP_DATA_TEMP = 'trip_data.tmp'    # Тимчасовий файл, що використовується під час збереження.

# Інтервал збереження персистентних даних на Flash пам'ять (мс).
# Зберігання даних на Flash є операцією з обмеженим терміном служби, тому не варто робити це занадто часто.
PERSISTENT_SAVE_INTERVAL_MS = const(10000) # Кожні 10 секунд.

# ------------------------------------------------------------------------------
# 9. Безпека.
# ------------------------------------------------------------------------------
WATCHDOG_TIME_RESET = 8000 # Watchdog перезавантажить мікроконтролер, якщо програма зависне.

# ------------------------------------------------------------------------------
# 10. Налаштування звуку при активації TRIP-вікна (зворотний зв'язок для користувача)
# ------------------------------------------------------------------------------
BUTTON_TRIP_READY_BEEP_FREQ = const(1500)           # Частота короткого звукового сигналу (Гц)
                                                    # 1500 Гц — помітний, але не надто різкий тон.
BUTTON_TRIP_READY_BEEP_DURATION_SEC = const(0.03)   # Тривалість звуку (секунди)
                                                    # 30 мс — дуже короткий "пік", щоб не дратувати.
# ------------------------------------------------------------------------------
# 11. Налаштування ADC
# ------------------------------------------------------------------------------
VOLTAGE_R1 = 10000.0 # 10k Ом
VOLTAGE_R2 = 2000.0 # 2k Ом
# Розрахунок коефіцієнта (для переводу одиниць ADC в реальні Вольти)
VOLTAGE_CALIBRATION = (3.3 / 65535) * ((VOLTAGE_R1 + VOLTAGE_R2) / VOLTAGE_R2)
