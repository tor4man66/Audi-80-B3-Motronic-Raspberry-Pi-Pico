# ==============================================================================
# –ü—Ä–æ–µ–∫—Ç: –ë–æ—Ä—Ç–æ–≤–∏–π –ö–æ–º–ø'—é—Ç–µ—Ä –¥–ª—è Audi 80 B3 Mono Motronic –Ω–∞ Raspberry Pi Pico
# –ê–≤—Ç–æ—Ä: tor4man66
# –§–∞–π–ª: Main Logic (–∑ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–æ–º –ø–∞–ª–∏–≤–∞)
# –û–ø–∏—Å: –û—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ–≥—Ä–∞–º–Ω–∏–π –∫–æ–¥ –±–æ—Ä—Ç–æ–≤–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞. –í–∫–ª—é—á–∞—î –ª–æ–≥—ñ–∫—É
#       –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö –∑ –¥–∞—Ç—á–∏–∫—ñ–≤, —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤, –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–æ–º –¥–≤–∏–≥—É–Ω–∞,
#       –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫, –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö, –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
#       —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–∞ OLED –¥–∏—Å–ø–ª–µ—ó, —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É
#       —Ç–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω—É –ª–æ–≥—ñ–∫—É –æ–±—Ä–æ–±–∫–∏ –∫–Ω–æ–ø–∫–∏.
# –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: 2026-01-14
# ==============================================================================

# -------------------------------------------------------------------------
# 0. –Ü–ú–ü–û–†–¢ –ú–û–î–£–õ–Ü–í
#    –Ü–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –∞–ø–∞—Ä–∞—Ç–Ω–∏–º –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è–º
#    (–ø—ñ–Ω–∏, I2C, PWM, ADC), —á–∞—Å–æ–º, —Ñ–∞–π–ª–æ–≤–æ—é —Å–∏—Å—Ç–µ–º–æ—é —Ç–∞ –≥—Ä–∞—Ñ—ñ–∫–æ—é.
# -------------------------------------------------------------------------
from machine import Pin, I2C, disable_irq, enable_irq, PWM, ADC
import time
import framebuf
import os

# –Ü–º–ø–æ—Ä—Ç –∫–∞—Å—Ç–æ–º–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Ç–∞ —ñ–∫–æ–Ω–æ–∫.
import Settings # –ú—ñ—Å—Ç–∏—Ç—å –≤—Å—ñ –∫–∞–ª—ñ–±—Ä—É–≤–∞–ª—å–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.
import Icons    # –ú—ñ—Å—Ç–∏—Ç—å –±—ñ—Ç–æ–≤—ñ –º–∞–ø–∏ —ñ–∫–æ–Ω–æ–∫ –¥–ª—è –¥–∏—Å–ø–ª–µ—è.

# –°–ø—Ä–æ–±–∞ —ñ–º–ø–æ—Ä—Ç—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –¥–ª—è OLED –¥–∏—Å–ø–ª–µ—è SH1107.
# –Ø–∫—â–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞, –¥–∏—Å–ø–ª–µ–π –±—É–¥–µ –≤–∏–º–∫–Ω–µ–Ω–æ, —ñ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –±–µ–∑ –Ω—å–æ–≥–æ.
try:
    import sh1107
except ImportError:
    print("–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ sh1107 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –î–∏—Å–ø–ª–µ–π –±—É–¥–µ –≤–∏–º–∫–Ω–µ–Ω–æ.")
    sh1107 = None

# -------------------------------------------------------------------------
# 1. –§–£–ù–ö–¶–Ü–á –î–õ–Ø –ì–†–ê–§–Ü–ö–ò (SH1107 EXTENSIONS)
#    –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ sh1107 –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ä–æ–∑—Ç—è–≥–Ω—É—Ç–æ–≥–æ
#    —Ç–µ–∫—Å—Ç—É —Ç–∞ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫—ñ–≤ —ñ–∑ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–∏–º–∏ –∫—É—Ç–∞–º–∏.
# -------------------------------------------------------------------------

# –¢–∏–º—á–∞—Å–æ–≤–∏–π –±—É—Ñ–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –æ–∫—Ä–µ–º–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤ (8x8 –ø—ñ–∫—Å–µ–ª—ñ–≤).
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–æ–∑—Ç—è–≥—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –Ω–∞ OLED.
_temp_fb_char = None
if sh1107: # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –¥—Ä–∞–π–≤–µ—Ä –¥–∏—Å–ø–ª–µ—è –¥–æ—Å—Ç—É–ø–Ω–∏–π.
    try:
        # –ë—É—Ñ–µ—Ä 8 –±–∞–π—Ç –¥–ª—è 8x8 –º–æ–Ω–æ—Ö—Ä–æ–º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª—É (8*8/8=8 –±–∞–π—Ç).
        _temp_char_buffer = bytearray(8)
        # FrameBuffer –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ü–∏–º –±—É—Ñ–µ—Ä–æ–º.
        _temp_fb_char = framebuf.FrameBuffer(_temp_char_buffer, 8, 8, framebuf.MONO_VLSB)
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó _temp_fb_char: {e}")
        _temp_fb_char = None

def _draw_stretched_char(oled_obj, char, start_x, y, size_x, size_y, c=1):
    """
    –ú–∞–ª—é—î –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª, —Ä–æ–∑—Ç—è–≥–Ω—É—Ç–∏–π –¥–æ –∑–∞–¥–∞–Ω–∏—Ö —Ä–æ–∑–º—ñ—Ä—ñ–≤ (size_x, size_y).
    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î _temp_fb_char –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É —Å–∏–º–≤–æ–ª—É, –∞ –ø–æ—Ç—ñ–º –º–∞–ª—é—î —Ä–æ–∑—Ç—è–≥–Ω—É—Ç—ñ
    –ø—ñ–∫—Å–µ–ª—ñ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º—É OLED-–±—É—Ñ–µ—Ä—ñ.
    """
    if _temp_fb_char is None:
        # Fallback: —è–∫—â–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π –±—É—Ñ–µ—Ä –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ, –º–∞–ª—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Ç–µ–∫—Å—Ç.
        oled_obj.text(char, start_x, y, c)
        return start_x + 8 # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —à–∏—Ä–∏–Ω—É —Å–∏–º–≤–æ–ª—É.

    _temp_fb_char.fill(0) # –û—á–∏—â–∞—î–º–æ –±—É—Ñ–µ—Ä —Å–∏–º–≤–æ–ª—É.
    _temp_fb_char.text(char, 0, 0, 1) # –ú–∞–ª—é—î–º–æ —Å–∏–º–≤–æ–ª —É —Ç–∏–º—á–∞—Å–æ–≤–æ–º—É –±—É—Ñ–µ—Ä—ñ.

    # –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –ø—ñ–∫—Å–µ–ª—è—Ö 8x8 –±—É—Ñ–µ—Ä–∞ —Å–∏–º–≤–æ–ª—É —Ç–∞ –º–∞–ª—é—î–º–æ —Ä–æ–∑—Ç—è–≥–Ω—É—Ç—ñ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∏ –Ω–∞ OLED.
    for dy in range(8):
        for dx in range(8):
            if _temp_fb_char.pixel(dx, dy): # –Ø–∫—â–æ –ø—ñ–∫—Å–µ–ª—å —É —Å–∏–º–≤–æ–ª—ñ –∞–∫—Ç–∏–≤–Ω–∏–π...
                # ...–º–∞–ª—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ä–æ–∑—Ç—è–≥–Ω—É—Ç–∏–π –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫ –Ω–∞ –¥–∏—Å–ø–ª–µ—ó.
                oled_obj.fill_rect(start_x + dx * size_x, y + dy * size_y, size_x, size_y, c)
    return start_x + 8 * size_x # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª—É.

def stretched_text_optimized(self, s, x, y, size_x, size_y, c=1):
    """
    –ú–∞–ª—é—î —Ä—è–¥–æ–∫ —Ç–µ–∫—Å—Ç—É, —Ä–æ–∑—Ç—è–≥–Ω—É—Ç–∏–π –ø–æ X —Ç–∞ Y –æ—Å—è—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é _draw_stretched_char.
    """
    current_x = x
    for char in s:
        current_x = _draw_stretched_char(self, char, current_x, y, size_x, size_y, c)

def draw_frame_rect_with_rounded_corners(self, x, y, w, h, r, c=1):
    """
    –ú–∞–ª—é—î –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫ –∑ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–∏–º–∏ –∫—É—Ç–∞–º–∏ (—Ç–æ–≤—â–∏–Ω–∞ 1px, r - —Ä–∞–¥—ñ—É—Å).
    –ü—Ä–∏–º—ñ—Ç–∫–∞: –ü–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è r > 1 –º–∞–ª—é—î –ª–∏—à–µ 8 –∫—É—Ç–æ–≤–∏—Ö –ø—ñ–∫—Å–µ–ª—ñ–≤, —â–æ –¥–∞—î –º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ
    –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è, –∞ –Ω–µ –ø–æ–≤–Ω—ñ –¥—É–≥–∏. –î–ª—è —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è (—è–∫ –Ω–∞ –±—ñ–ª—å—à–∏—Ö —Ä–∞–¥—ñ—É—Å–∞—Ö)
    –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º –º–∞–ª—é–≤–∞–Ω–Ω—è —á–≤–µ—Ä—Ç—ñ –∫–æ–ª–∞ –∞–±–æ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é, —â–æ
    –º–æ–∂–µ –±—É—Ç–∏ —Ä–µ—Å—É—Ä—Å–æ—î–º–Ω–∏–º –¥–ª—è –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞.
    """
    # 1. –ú–∞–ª—é—î–º–æ —á–æ—Ç–∏—Ä–∏ –ø—Ä—è–º—ñ —Å–µ–∫—Ü—ñ—ó, –∑—É–ø–∏–Ω—è—é—á–∏—Å—å –∑–∞ r –ø—ñ–∫—Å–µ–ª—ñ–≤ –¥–æ –∫—É—Ç–∞.
    self.hline(x + r, y, w - 2 * r, c)           # –í–µ—Ä—Ö–Ω—è –ª—ñ–Ω—ñ—è
    self.hline(x + r, y + h - 1, w - 2 * r, c)   # –ù–∏–∂–Ω—è –ª—ñ–Ω—ñ—è
    self.vline(x, y + r, h - 2 * r, c)           # –õ—ñ–≤–∞ –ª—ñ–Ω—ñ—è
    self.vline(x + w - 1, y + r, h - 2 * r, c)   # –ü—Ä–∞–≤–∞ –ª—ñ–Ω—ñ—è

    # 2. –ú–∞–ª—é—î–º–æ 8 –∫—É—Ç–æ–≤–∏—Ö –ø—ñ–∫—Å–µ–ª—ñ–≤ (–¥–ª—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –ø—Ä–∏ r=2)
    # –ó–≤–µ—Ä—Ö—É-–ª—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ –∫—É—Ç–∞
    self.pixel(x + r - 1, y, c)
    self.pixel(x, y + r - 1, c)

    # –ó–≤–µ—Ä—Ö—É-–ø—Ä–∞–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ –∫—É—Ç–∞
    self.pixel(x + w - r, y, c)
    self.pixel(x + w - 1, y + r - 1, c)

    # –ó–Ω–∏–∑—É-–ª—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ –∫—É—Ç–∞
    self.pixel(x + r - 1, y + h - 1, c)
    self.pixel(x, y + h - r, c)

    # –ó–Ω–∏–∑—É-–ø—Ä–∞–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ –∫—É—Ç–∞
    self.pixel(x + w - r, y + h - 1, c)
    self.pixel(x + w - 1, y + h - r, c)

# –Ø–∫—â–æ –¥—Ä–∞–π–≤–µ—Ä sh1107 —Ç–∞ —Ç–∏–º—á–∞—Å–æ–≤–∏–π –±—É—Ñ–µ—Ä —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ, –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –º–µ—Ç–æ–¥–∏ –¥–æ –æ–±'—î–∫—Ç–∞ OLED.
if sh1107 and _temp_fb_char:
    sh1107.SH1107_I2C.stretched_text = stretched_text_optimized

    def large_text_wrapper(self, s, x, y, size, c=1):
        """–û–±–≥–æ—Ä—Ç–∫–∞ –¥–ª—è stretched_text_optimized, —â–æ–± —Å–ø—Ä–æ—Å—Ç–∏—Ç–∏ –≤–∏–∫–ª–∏–∫ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤."""
        stretched_text_optimized(self, s, x, y, size, size, c)
    sh1107.SH1107_I2C.large_text = large_text_wrapper
    sh1107.SH1107_I2C.round_rect = draw_frame_rect_with_rounded_corners

# -------------------------------------------------------------------------
# 2. –í–ò–ó–ù–ê–ß–ï–ù–ù–Ø –ì–†–£–ü –ü–û–ú–ò–õ–û–ö
#    –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç—ñ–≤ –ø–æ–º–∏–ª–æ–∫, —è–∫—ñ –º–∞—é—Ç—å –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª
#    —Ç–∞ –≤–≤–∞–∂–∞—Ç–∏—Å—è –∫—Ä–∏—Ç–∏—á–Ω–∏–º–∏.
# -------------------------------------------------------------------------
# –í—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ –ø–æ–º–∏–ª–∫–∏, —Ç–µ–∫—Å—Ç–∏ —è–∫–∏—Ö —î –≤ —Ü—å–æ–º—É —Å–ø–∏—Å–∫—É, –≤–∏–∫–ª–∏–∫–∞—é—Ç—å –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª
# —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è —è–∫ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è.
ALL_SOUND_TRIGGERING_ERROR_TEXTS = [
    Icons.ERROR_ICONS['0_3_AND_1_8_PRESSURE_OIL']['text'],           # –ù–∏–∑—å–∫–∏–π —Ç–∏—Å–∫ –º–∞—Å—Ç–∏–ª–∞ (0.3 –±–∞—Ä)
    Icons.ERROR_ICONS['OVERHEAT_AND_LOW_COOLANT']['text'],          # –ü–µ—Ä–µ–≥—Ä—ñ–≤ –¥–≤–∏–≥—É–Ω–∞ / –ù–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å –æ—Ö–æ–ª–æ–¥–∂—É–≤–∞–ª—å–Ω–æ—ó —Ä—ñ–¥–∏–Ω–∏
    Icons.ERROR_ICONS['BRAKE_FLUID']['text'],       # –ù–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å –≥–∞–ª—å–º—ñ–≤–Ω–æ—ó —Ä—ñ–¥–∏–Ω–∏
    Icons.ERROR_ICONS['0_3_AND_1_8_PRESSURE_OIL']['text'], # –ù–∏–∑—å–∫–∏–π —Ç–∏—Å–∫ –º–∞—Å—Ç–∏–ª–∞ (1.8 –±–∞—Ä)
]

# -------------------------------------------------------------------------
# 3. –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü –°–¢–ê–ù–£
#    –¢—É—Ç –æ–≥–æ–ª–æ—à—É—é—Ç—å—Å—è –≤—Å—ñ –≥–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ, —è–∫—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å —Å—Ç–∞–Ω –ø—Ä–æ–≥—Ä–∞–º–∏.
#    –¶—ñ –∑–º—ñ–Ω–Ω—ñ –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è —è–∫ —É –≥–æ–ª–æ–≤–Ω–æ–º—É —Ü–∏–∫–ª—ñ, —Ç–∞–∫ —ñ –≤ –æ–±—Ä–æ–±–Ω–∏–∫–∞—Ö
#    –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω—å (IRQ).
# -------------------------------------------------------------------------
# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–æ—é.
current_battery_voltage = 14.0 # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ (14–í ‚Äî –µ—Ç–∞–ª–æ–Ω –¥–ª—è –∑–∞–≤–µ–¥–µ–Ω–æ–≥–æ –∞–≤—Ç–æ)
blink_state = True # –ó–º—ñ–Ω–Ω–∞ –¥–ª—è –±–ª–∏–º–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ –Ω–∞–ø—Ä—É–≥–∏—é.


# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è DEAD TIME.
dynamic_dead_time_us = Settings.INJ_DEAD_TIME_US # –ü—Ä–∏—Å–≤–æ—é—î–º–æ –∑–º—ñ–Ω–Ω—ñ–π –∫–æ—Ä–µ–∫—Ü—ñ—ó –±–∞–∑–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ Settings.
last_voltage_update_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏ (—É –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö).

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Å–∏–≥–Ω–∞–ª—ñ–≤ —Ñ–æ—Ä—Å—É–Ω–∫–∏ —Ç–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ (–æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤ IRQ).
rpm = 0                    # –û–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ (RPM), —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω—ñ –∑ —ñ–º–ø—É–ª—å—Å—ñ–≤ —Ñ–æ—Ä—Å—É–Ω–∫–∏.
total_pulse_time_us = 0    # –ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Å –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä—Å—É–Ω–∫–∏ –∑–∞ —ñ–Ω—Ç–µ—Ä–≤–∞–ª (–º–∫—Å). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∏—Ç—Ä–∞—Ç–∏ –ø–∞–ª–∏–≤–∞.
current_inj_period_us = 0  # –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —ñ–º–ø—É–ª—å—Å—É —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–º–∫—Å), —â–æ–π–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞.
vss_pulse_count = 0        # –ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—ñ–≤ –¥–∞—Ç—á–∏–∫–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ (VSS) –∑–∞ —ñ–Ω—Ç–µ—Ä–≤–∞–ª.
last_pulse_edge_us = 0     # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Ñ—Ä–æ–Ω—Ç—É —Å–∏–≥–Ω–∞–ª—É —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—É).
last_vss_pulse_us = 0      # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —ñ–º–ø—É–ª—å—Å—É VSS (–¥–ª—è –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥—É).
last_inj_start_us = 0      # –ß–∞—Å –ø–æ—á–∞—Ç–∫—É –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —ñ–º–ø—É–ª—å—Å—É —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É RPM).
last_inj_irq_time_us = 0   # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è IRQ —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–¥–ª—è –¥–µ–±–∞—É–Ω—Å—É IRQ).
avg_inj_ms = 0.0  # –ó–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–≥–ª–∞–¥–∂–µ–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —á–∞—Å—É –≤–ø–æ—Ä—Å–∫—É–≤–∞–Ω–Ω—è –Ω–∞ —Å–ø–µ—Ü –µ–∫—Ä–∞–Ω—ñ

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–æ–º –¥–≤–∏–≥—É–Ω–∞.
is_engine_running = False  # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å: True, —è–∫—â–æ –¥–≤–∏–≥—É–Ω –ø—Ä–∞—Ü—é—î (—î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ñ–æ—Ä—Å—É–Ω–∫–∏).
last_inj_activity_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –∑—É–ø–∏–Ω–∫–∏ –¥–≤–∏–≥—É–Ω–∞).
last_vss_activity_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ VSS.
engine_start_time_ms = 0   # –ß–∞—Å (–º—Å), –∫–æ–ª–∏ –¥–≤–∏–≥—É–Ω "—Å—Ö–æ–ø–∏–≤" (–ø–æ—á–∞–≤ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–∞—Ç—Ä–∏–º–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∏—Å–∫—É –º–∞—Å–ª–∞.
is_engine_running_stable = False # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å: True, —è–∫—â–æ –¥–≤–∏–≥—É–Ω –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ (RPM –≤–∏—â–µ –ø–æ—Ä–æ–≥—É).
last_stable_rpm_time_ms = 0 # –ß–∞—Å (–º—Å), –∫–æ–ª–∏ RPM –≤–æ—Å—Ç–∞–Ω–Ω—î –±—É–≤ –≤–∏—â–µ –ø–æ—Ä–æ–≥—É —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏.

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—ó–∑–¥–æ–∫ (TRIP —Ç–∞ PERS).
trip_fuel_consumed_L = 0.0          # –ù–∞–∫–æ–ø–∏—á–µ–Ω–µ –ø–∞–ª–∏–≤–æ –∑–∞ –ø–æ—Ç–æ—á–Ω—É –ø–æ—ó–∑–¥–∫—É (TRIP).
trip_distance_travelled_km = 0.0    # –ü—Ä–æ–π–¥–µ–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –∑–∞ –ø–æ—Ç–æ—á–Ω—É –ø–æ—ó–∑–¥–∫—É (TRIP).
persistent_trip_fuel_L = 0.0        # –ù–∞–∫–æ–ø–∏—á–µ–Ω–µ –ø–∞–ª–∏–≤–æ –∑–∞ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é (PERS).
persistent_trip_distance_km = 0.0   # –ü—Ä–æ–π–¥–µ–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –∑–∞ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é (PERS).
last_persistent_save_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö –Ω–∞ Flash.

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –¥–∏—Å–ø–ª–µ—î–º —Ç–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.
current_display_mode = "MAIN"   # –ü–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è: "MAIN", "ERROR_CYCLE", "LOW_FUEL_CYCLE", "SPECIAL_SCREEN".
last_display_update_time = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Å–ø–ª–µ—è.
blink_on = True                 # –°—Ç–∞—Ç—É—Å –±–ª–∏–º–∞–Ω–Ω—è –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.
last_blink_toggle_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –±–ª–∏–º–∞–Ω–Ω—è.

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–Ω–æ–ø–∫–∏ —Å–∫–∏–¥–∞–Ω–Ω—è/—Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É.
button_trip_ready_beep_played = False # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, –∑–≤—É–∫ TRIP-–≤—ñ–∫–Ω–∞ –≤–∂–µ –ø—Ä–æ–ª—É–Ω–∞–≤
button_press_timer_start = 0        # –ß–∞—Å (–º—Å) –ø–æ—á–∞—Ç–∫—É —É—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏.
button_trip_reset_candidate = False # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å: True, —è–∫—â–æ –∫–Ω–æ–ø–∫—É —Ç—Ä–∏–º–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–æ–≤–≥–æ –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è TRIP, –∞–ª–µ –Ω–µ –¥–ª—è —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É.
button_special_screen_triggered = False # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ –∞–∫—Ç–∏–≤–∞—Ü—ñ—è —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É –≤–∂–µ –≤—ñ–¥–±—É–ª–∞—Å—è –∑–∞ —Ü–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è.
button_special_screen_beep_played = False # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ –ø–æ–¥–≤—ñ–π–Ω–∏–π —Å–∏–≥–Ω–∞–ª –¥–ª—è —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É –≤–∂–µ –ø—Ä–æ–ª—É–Ω–∞–≤.

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –∑–≤—É–∫–æ–≤–æ—ó —Å–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó.
active_errors = []              # –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.
current_error_display_index = 0 # –ü–æ—Ç–æ—á–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –ø–æ–º–∏–ª–∫–∏ –≤ —Ü–∏–∫–ª—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (—è–∫—â–æ –∫—ñ–ª—å–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω—ñ).
last_error_cycle_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ –ø–æ–º–∏–ª–∫–∏ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ.
sensor_alarm_active = False     # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å: True, —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª —Ç—Ä–∏–≤–æ–≥–∏.
alarm_phase = 0                 # –ü–æ—Ç–æ—á–Ω–∞ —Ñ–∞–∑–∞ –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É (—ñ–Ω–¥–µ–∫—Å —É ALARM_SEQUENCE).
alarm_phase_start_time_ms = 0   # –ß–∞—Å –ø–æ—á–∞—Ç–∫—É –ø–æ—Ç–æ—á–Ω–æ—ó —Ñ–∞–∑–∏ –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É.
_queued_errors_for_next_cycle = [] # –ß–µ—Ä–≥–∞ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ü–∏–∫–ª—É –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
file_error_count = 0            # –õ—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ (–¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ –µ–∫—Ä–∞–Ω—ñ).

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –¥–∏–Ω–∞–º—ñ–∫–∞/–∑—É–º–µ—Ä–∞.
current_speaker_freq = 0 # –ü–æ—Ç–æ—á–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ –¥–∏–Ω–∞–º—ñ–∫–∞.
current_speaker_duty = 0 # –ü–æ—Ç–æ—á–Ω–∞ —à–ø–∞—Ä—É–≤–∞—Ç—ñ—Å—Ç—å –¥–∏–Ω–∞–º—ñ–∫–∞ (0 = –≤–∏–º–∫–Ω–µ–Ω–æ, 32768 = 50%).

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ –ø–∞–ª–∏–≤–∞ —Ç–∞ –π–æ–≥–æ –ª–æ–≥—ñ–∫–∏.
fuel_level_adc = None           # –û–±'—î–∫—Ç ADC –¥–ª—è –ø–∞–ª–∏–≤–∞ (—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ).
fuel_buffer = [0] * Settings.FUEL_BUFFER_SIZE # –ë—É—Ñ–µ—Ä –¥–ª—è –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å —Ä—ñ–≤–Ω—è –ø–∞–ª–∏–≤–∞.
last_smoothed_fuel_percent = 0.0 # –û—Å—Ç–∞–Ω–Ω—î –∑–≥–ª–∞–¥–∂–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–∞–ª–∏–≤–∞ (—É –≤—ñ–¥—Å–æ—Ç–∫–∞—Ö).
last_fuel_update_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è –ø–∞–ª–∏–≤–∞.
is_low_fuel_active_by_hysteresis = False # –°—Ç–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞" –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –≥—ñ—Å—Ç–µ—Ä–µ–∑–∏—Å—É.
low_fuel_display_state = 0      # 0: –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ LOW_FUEL, 1: –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ Main Screen (–¥–ª—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª—É).
low_fuel_last_state_change_time_ms = time.ticks_ms() # –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞".

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ –ø–æ–∫–∞–∑–Ω–∏–∫–∞ (L/H –∞–±–æ L/100KM).
main_val_buffer = [0.0] * Settings.MAIN_VAL_BUFFER_SIZE # –ë—É—Ñ–µ—Ä –¥–ª—è –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –º–∏—Ç—Ç—î–≤–æ—ó –≤–∏—Ç—Ä–∞—Ç–∏.
last_display_unit = "L/H" # –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–æ–º–µ–Ω—Ç—É –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è L/H / L/100KM.

# –ó–º—ñ–Ω–Ω—ñ –¥–ª—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É.
special_screen_active_time_ms = 0 # –ß–∞—Å (–º—Å) –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É.

wdt = None  # –û–±'—î–∫—Ç Watchdog (—Å—Ç–æ—Ä–æ–∂–æ–≤–∏–π —Ç–∞–π–º–µ—Ä), —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ.

# -------------------------------------------------------------------------
# 4. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ü–Ü–ù–Ü–í
#    –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤ —Ä–æ–±–æ—Ç–∏ GPIO –ø—ñ–Ω—ñ–≤ (–≤—Ö—ñ–¥/–≤–∏—Ö—ñ–¥, –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è),
#    –∞ —Ç–∞–∫–æ–∂ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–∏—Ñ–µ—Ä—ñ–π–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ (PWM, ADC, Watchdog).
# -------------------------------------------------------------------------

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—Ö—ñ–¥–Ω–∏—Ö –ø—ñ–Ω—ñ–≤ –∑ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–º –ø—ñ–¥—Ç—è–≥—É—é—á–∏–º —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–º (PULL_UP).
# –¶–µ —Ç–∏–ø–æ–≤–æ –¥–ª—è –¥–∞—Ç—á–∏–∫—ñ–≤, —è–∫—ñ "–∑–∞–∫–æ—Ä–æ—á—É—é—Ç—å" –ø—ñ–Ω –Ω–∞ –∑–µ–º–ª—é –ø—Ä–∏ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—ñ (–∞–∫—Ç–∏–≤–Ω–∏–π –Ω–∏–∑—å–∫–∏–π —Å–∏–≥–Ω–∞–ª).
INJ_PIN = Pin(Settings.PIN_INJ, Pin.IN, Pin.PULL_UP)
VSS_PIN = Pin(Settings.PIN_VSS, Pin.IN, Pin.PULL_UP)
RESET_BUTTON_PIN = Pin(Settings.PIN_BUTTON_RESET, Pin.IN, Pin.PULL_UP)
BRAKE_FLUID_SENSOR_PIN = Pin(Settings.PIN_SENSOR_BRAKE_FLUID, Pin.IN, Pin.PULL_UP)
OIL_PRESSURE_0_3_SENSOR_PIN = Pin(Settings.PIN_SENSOR_OIL_PRESSURE_0_3, Pin.IN, Pin.PULL_UP)
OVERHEAT_AND_LOW_COOLANT_SENSOR_PIN = Pin(Settings.PIN_SENSOR_OVERHEAT_AND_LOW_COOLANT, Pin.IN, Pin.PULL_UP)
OIL_PRESSURE_1_8_SENSOR_PIN = Pin(Settings.PIN_SENSOR_OIL_PRESSURE_1_8, Pin.IN, Pin.PULL_UP)

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ–Ω–∞ ADC 12V
voltage_adc = ADC(Pin(Settings.PIN_ADC))

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è PWM –¥–ª—è –¥–∏–Ω–∞–º—ñ–∫–∞.
# –î–∏–Ω–∞–º—ñ–∫ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ –ø—ñ–Ω–∞ SPEAKE_PIN.
try:
    pwm_speaker = PWM(Pin(Settings.PIN_SPEAKER, Pin.OUT))
    pwm_speaker.freq(1000) # –ü–æ—á–∞—Ç–∫–æ–≤–∞ —á–∞—Å—Ç–æ—Ç–∞ 1000 –ì—Ü.
    pwm_speaker.duty_u16(0) # –î–∏–Ω–∞–º—ñ–∫ –≤–∏–º–∫–Ω–µ–Ω–æ (0% —à–ø–∞—Ä—É–≤–∞—Ç–æ—Å—Ç—ñ).
    current_speaker_duty = 0
except Exception as e:
    pwm_speaker = None
    print(f"–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–∏–Ω–∞–º—ñ–∫–∞: {e}")

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Watchdog (—Å—Ç–æ—Ä–æ–∂–æ–≤–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞).
# Watchdog –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä, —è–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ –∑–∞–≤–∏—Å–Ω–µ (–Ω–µ "–≥–æ–¥—É–≤–∞—Ç–∏–º–µ" –π–æ–≥–æ).
try:
    import machine
    wdt = machine.WDT(timeout=Settings.WATCHDOG_TIME_RESET)  # 8 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç.
    print(f"‚úÖ Watchdog –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ ({Settings.WATCHDOG_TIME_RESET} ms)")
except Exception as e:
    print(f"‚ö†Ô∏è Watchdog –ø–æ–º–∏–ª–∫–∞: {e}")

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ADC –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ –ø–∞–ª–∏–≤–∞.
# –ê–Ω–∞–ª–æ–≥–æ–≤–∏–π –¥–∞—Ç—á–∏–∫ —Ä—ñ–≤–Ω—è –ø–∞–ª–∏–≤–∞ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ ADC –ø—ñ–Ω–∞.
try:
    fuel_level_adc = ADC(Pin(Settings.PIN_FUEL_LEVEL_ADC))
except Exception as e:
    fuel_level_adc = None
    print(f"–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó ADC –¥–ª—è –ø–∞–ª–∏–≤–∞: {e}")

# -------------------------------------------------------------------------
# 5. –°–ò–°–¢–ï–ú–ù–Ü –§–£–ù–ö–¶–Ü–á –¢–ê –õ–û–ì–Ü–ö–ê
#    –§—É–Ω–∫—Ü—ñ—ó, —â–æ —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å –æ—Å–Ω–æ–≤–Ω—É –ª–æ–≥—ñ–∫—É —Ä–æ–±–æ—Ç–∏ –±–æ—Ä—Ç–æ–≤–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞.
# -------------------------------------------------------------------------

def draw_batt_icon(oled, x, y, v_val, current_time_ms):
    """
    –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∞.
    """
    # –£–º–æ–≤–∞ –¥–ª—è –±–ª–∏–º–∞–Ω–Ω—è:
    # –Ø–∫—â–æ –Ω–∞–ø—Ä—É–≥–∞ –º–µ–Ω—à–µ 13.2 –Ü –∑–∞—Ä–∞–∑ "—Ñ–∞–∑–∞ –≤–∏–º–∫–Ω–µ–Ω–Ω—è" (–∫–æ–∂–Ω—ñ 500 –º—Å) ‚Äî –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó
    if v_val < 13.2 and (current_time_ms // 1000) % 2 == 0:
        return  # –ù—ñ—á–æ–≥–æ –Ω–µ –º–∞–ª—é—î–º–æ, —Ç–æ–º—É –≤–æ–Ω–æ –∑–Ω–∏–∫–∞—î (–±–ª–∏–º–∞—î)

    # 1. –ö–æ—Ä–ø—É—Å –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∞
    oled.rect(x, y, 38, 26, 1)
    oled.fill_rect(x + 5, y - 2, 4, 2, 1) # –ö–ª–µ–º–∞
    oled.fill_rect(x + 27, y - 2, 4, 2, 1) # –ö–ª–µ–º–∞

    # 3. –ù–∞–ø—Ä—É–≥–∞ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
    v_str = "{:.1f}".format(v_val)
    oled.stretched_text(v_str, x + 3, y + 6, 1, 2, 1)

def update_voltage_correction():
    global current_battery_voltage, dynamic_dead_time_us
    """
    –ö–æ—Ä–µ–∫—Ü—ñ—è DEAD TIME —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    """
    # 1. –ß–∏—Ç–∞—î–º–æ ADC (0-65535)
    raw_v = voltage_adc.read_u16()

    # –ú–Ω–æ–∂–∏–º–æ –Ω–∞ –≥–æ—Ç–æ–≤–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —ñ–∑ Settings
    current_battery_voltage = raw_v * Settings.VOLTAGE_CALIBRATION

    # –ö–æ—Ä–µ–∫—Ü—ñ—è —á–∞—Å—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä—Å—É–Ω–∫–∏ (Dead Time)
    # –Ø–∫—â–æ –Ω–∞–ø—Ä—É–≥–∞ –∑–∞–Ω–∞–¥—Ç–æ –º–∞–ª–∞ (–º–∞—à–∏–Ω–∞ –≤–∏–º–∫–Ω–µ–Ω–∞), –±–µ—Ä–µ–º–æ 14–í —è–∫ –±–∞–∑—É
    v_for_corr = current_battery_voltage if current_battery_voltage > 8.0 else 14.0
    voltage_diff = 14.0 - v_for_corr

    new_dt = Settings.INJ_DEAD_TIME_US + (voltage_diff * Settings.INJ_VOLT_SENSITIVITY)
    # –û–±–º–µ–∂—É—î–º–æ, —â–æ–± –Ω–µ –±—É–ª–æ –ø–æ–º–∏–ª–æ–∫ —É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∞—Ö
    dynamic_dead_time_us = int(max(0, min(500, new_dt)))

def get_current_rpm_atomic():
    """
    –ë–µ–∑–ø–µ—á–Ω–æ (–∞—Ç–æ–º–∞—Ä–Ω–æ) –∑—á–∏—Ç—É—î –ø–æ—Ç–æ—á–Ω—ñ –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ (rpm) –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó.
    –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è disable_irq/enable_irq –∑–∞–ø–æ–±—ñ–≥–∞—î race conditions, –∫–æ–ª–∏ IRQ
    –º–æ–∂–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∑–º—ñ–Ω–Ω—É –ø—ñ–¥ —á–∞—Å —ó—ó –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–∏–º —Ü–∏–∫–ª–æ–º.
    """
    global rpm
    irq_state = disable_irq() # –¢–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è.
    current_rpm_value = rpm
    enable_irq(irq_state)     # –ó–Ω–æ–≤—É –≤–º–∏–∫–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è.
    return current_rpm_value

def get_current_inj_period_atomic():
    """
    –ë–µ–∑–ø–µ—á–Ω–æ (–∞—Ç–æ–º–∞—Ä–Ω–æ) –∑—á–∏—Ç—É—î –ø–æ—Ç–æ—á–Ω—É —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—É —Ñ–æ—Ä—Å—É–Ω–∫–∏ (current_inj_period_us).
    –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ race conditions –ø—ñ–¥ —á–∞—Å –¥–æ—Å—Ç—É–ø—É –¥–æ –∑–º—ñ–Ω–Ω–æ—ó, —â–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ IRQ.
    """
    global current_inj_period_us
    irq_state = disable_irq() # –¢–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è.
    current_period_value = current_inj_period_us
    enable_irq(irq_state)     # –ó–Ω–æ–≤—É –≤–º–∏–∫–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è.
    return current_period_value

def play_single_beep(freq, duration_sec):
    """–í—ñ–¥—Ç–≤–æ—Ä—é—î –æ–¥–∏–Ω –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª –∑–∞–¥–∞–Ω–æ—ó —á–∞—Å—Ç–æ—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ."""
    global pwm_speaker, current_speaker_freq, current_speaker_duty
    if pwm_speaker:
        pwm_speaker.freq(freq)
        pwm_speaker.duty_u16(32768) # 50% —à–ø–∞—Ä—É–≤–∞—Ç–æ—Å—Ç—ñ.
        time.sleep(duration_sec)
        pwm_speaker.duty_u16(0)
        current_speaker_duty = 0
        current_speaker_freq = 0

def play_special_screen_beeps():
    """–í—ñ–¥—Ç–≤–æ—Ä—é—î –ø–æ–¥–≤—ñ–π–Ω–∏–π –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É."""
    global pwm_speaker
    if pwm_speaker:
        play_single_beep(Settings.BUTTON_SPECIAL_SCREEN_BEEP_FREQ_1, Settings.BUTTON_SPECIAL_SCREEN_BEEP_DURATION_1)
        time.sleep(Settings.BUTTON_SPECIAL_SCREEN_BEEP_PAUSE_BETWEEN_SEC)
        play_single_beep(Settings.BUTTON_SPECIAL_SCREEN_BEEP_FREQ_2, Settings.BUTTON_SPECIAL_SCREEN_BEEP_DURATION_2)


def _get_error_severity_level(error_list):
    """
    –í–∏–∑–Ω–∞—á–∞—î —Ä—ñ–≤–µ–Ω—å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—ñ —Å–ø–∏—Å–∫—É –ø–æ–º–∏–ª–æ–∫.
    –†—ñ–≤–Ω—ñ:
    0: –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫.
    1: –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞"), –±–µ–∑ –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É.
    3: –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ (–≤–∏–º–∞–≥–∞—î –Ω–µ–≥–∞–π–Ω–æ—ó —É–≤–∞–≥–∏), –∑—ñ –∑–≤—É–∫–æ–≤–∏–º —Å–∏–≥–Ω–∞–ª–æ–º.
    """
    if not error_list or error_list == [Icons.ERROR_ICONS['NONE']]:
        return 0 # –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫.

    # –Ø–∫—â–æ —î –±—É–¥—å-—è–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ (—Ç–µ–∫—Å—Ç —è–∫–æ—ó —î —É ALL_SOUND_TRIGGERING_ERROR_TEXTS).
    if any(err['text'] in ALL_SOUND_TRIGGERING_ERROR_TEXTS for err in error_list):
        return 3 # –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞.

    # –Ø–∫—â–æ —î —Ç—ñ–ª—å–∫–∏ "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞" (—ñ –Ω–µ–º–∞—î –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö).
    if any(err['text'] == Icons.ERROR_ICONS['LOW_FUEL']['text'] for err in error_list):
        return 1 # –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞.

    return 0 # –î–µ—Ñ–æ–ª—Ç, —è–∫—â–æ –Ω–µ –ø—ñ–¥—ñ–π—à–ª–æ –∂–æ–¥–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è.

def manage_sensor_alarm():
    """
    –ö–µ—Ä—É—î –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—é –∑–≤—É–∫–æ–≤–æ—ó —Ç—Ä–∏–≤–æ–≥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ ALARM_SEQUENCE,
    –≤–∏–∑–Ω–∞—á–µ–Ω–æ—ó –≤ Settings.py.
    """
    global sensor_alarm_active, alarm_phase, alarm_phase_start_time_ms
    global pwm_speaker, current_speaker_freq, current_speaker_duty

    if pwm_speaker is None:
        return # –Ø–∫—â–æ –¥–∏–Ω–∞–º—ñ–∫ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ.

    if not sensor_alarm_active:
        # –Ø–∫—â–æ —Ç—Ä–∏–≤–æ–≥–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, –≤–∏–º–∏–∫–∞—î–º–æ –¥–∏–Ω–∞–º—ñ–∫ —ñ —Å–∫–∏–¥–∞—î–º–æ —Ñ–∞–∑–∏.
        if current_speaker_duty != 0:
            pwm_speaker.duty_u16(0)
            current_speaker_duty = 0
        alarm_phase = 0
        alarm_phase_start_time_ms = 0
        return

    current_time_ms = time.ticks_ms()
    if alarm_phase_start_time_ms == 0:
        alarm_phase_start_time_ms = current_time_ms # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —á–∞—Å—É –ø–æ—á–∞—Ç–∫—É –ø–µ—Ä—à–æ—ó —Ñ–∞–∑–∏.

    # –û—Ç—Ä–∏–º—É—î–º–æ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∞ —á–∞—Å—Ç–æ—Ç—É –ø–æ—Ç–æ—á–Ω–æ—ó —Ñ–∞–∑–∏ –∑ ALARM_SEQUENCE.
    phase_duration, phase_freq = Settings.ALARM_SEQUENCE[alarm_phase]

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Ñ–∞–∑–∏.
    if time.ticks_diff(current_time_ms, alarm_phase_start_time_ms) >= phase_duration:
        alarm_phase = (alarm_phase + 1) % len(Settings.ALARM_SEQUENCE) # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Ñ–∞–∑–∏ (—Ü–∏–∫–ª—ñ—á–Ω–æ).
        alarm_phase_start_time_ms = current_time_ms # –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –ø–æ—á–∞—Ç–∫—É –Ω–æ–≤–æ—ó —Ñ–∞–∑–∏.

        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–∏–Ω–∞–º—ñ–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –Ω–æ–≤–æ—ó —Ñ–∞–∑–∏.
        next_phase_duration, next_phase_freq = Settings.ALARM_SEQUENCE[alarm_phase]
        if next_phase_freq > 0:
            if current_speaker_freq != next_phase_freq:
                pwm_speaker.freq(next_phase_freq)
                current_speaker_freq = next_phase_freq
            if current_speaker_duty != 32768: # 50% —à–ø–∞—Ä—É–≤–∞—Ç–æ—Å—Ç—ñ –¥–ª—è –∑–≤—É–∫—É.
                pwm_speaker.duty_u16(32768)
                current_speaker_duty = 32768
        else: # –Ø–∫—â–æ —á–∞—Å—Ç–æ—Ç–∞ 0, –≤–∏–º–∏–∫–∞—î–º–æ –¥–∏–Ω–∞–º—ñ–∫.
            if current_speaker_duty != 0:
                pwm_speaker.duty_u16(0)
                current_speaker_duty = 0
    elif phase_freq > 0:
        # –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–∞ —Ñ–∞–∑–∞ —â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—è —ñ –º–∞—î –∑–≤—É–∫, –ø–µ—Ä–µ–∫–æ–Ω–∞—î–º–æ—Å—è,
        # —â–æ –¥–∏–Ω–∞–º—ñ–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é —á–∞—Å—Ç–æ—Ç–æ—é.
        if current_speaker_freq != phase_freq:
            pwm_speaker.freq(phase_freq)
            current_speaker_freq = phase_freq
        if current_speaker_duty != 32768:
            pwm_speaker.duty_u16(32768)
            current_speaker_duty = 32768

def get_raw_fuel_percent():
    """
    –ó—á–∏—Ç—É—î —Å–∏—Ä—ñ –¥–∞–Ω—ñ –∑ ADC –¥–∞—Ç—á–∏–∫–∞ –ø–∞–ª–∏–≤–∞ —Ç–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö –Ω–∞ –≤—ñ–¥—Å–æ—Ç–∫–∏ —Ä—ñ–≤–Ω—è –ø–∞–ª–∏–≤–∞ (0-100%).
    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –º–µ–¥—ñ–∞–Ω–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ –ø–æ–∫–∞–∑–∞–Ω—å.
    """
    if fuel_level_adc is None:
        return 0.0 # –Ø–∫—â–æ ADC –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ 0%.

    # –í–∏–∫–æ–Ω—É—î–º–æ –∫—ñ–ª—å–∫–∞ —à–≤–∏–¥–∫–∏—Ö –∑—á–∏—Ç—É–≤–∞–Ω—å ADC –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±—ñ–ª—å—à —Å—Ç–∞–±—ñ–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
    # —Ç–∞ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º–µ–¥—ñ–∞–Ω–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä (–±–µ—Ä–µ–º–æ 4-—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É).
    readings = [fuel_level_adc.read_u16() for _ in range(8)]
    raw_adc_value = sorted(readings)[3] # 4-—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è = –º–µ–¥—ñ–∞–Ω–∞ –¥–ª—è 8 –∑—á–∏—Ç—É–≤–∞–Ω—å.

    # –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —Å–∏—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è ADC –Ω–∞ –≤—ñ–¥—Å–æ—Ç–∫–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–∞–ª—ñ–±—Ä—É–≤–∞–ª—å–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å.
    # –ü—Ä–æ–ø–æ—Ä—Ü—ñ—è: (–ø–æ—Ç–æ—á–Ω–µ_–∑–Ω–∞—á–µ–Ω–Ω—è - –º—ñ–Ω—ñ–º—É–º) / (–º–∞–∫—Å–∏–º—É–º - –º—ñ–Ω—ñ–º—É–º)
    adc_range = Settings.FUEL_ADC_MAX_RAW - Settings.FUEL_ADC_MIN_RAW
    if adc_range == 0:
        return 0.0 # –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –¥—ñ–ª–µ–Ω–Ω—é –Ω–∞ –Ω—É–ª—å, —è–∫—â–æ –¥—ñ–∞–ø–∞–∑–æ–Ω ADC –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ.

    percent = (raw_adc_value - Settings.FUEL_ADC_MIN_RAW) / adc_range
    percent = max(0.0, min(1.0, percent)) # –û–±–º–µ–∂—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ 0.0-1.0.
    return percent * 100.0 # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤—ñ–¥—Å–æ—Ç–∫–∏ (0-100).

def process_fuel_smoothing():
    """
    –ó—á–∏—Ç—É—î —Ç–∞ –∑–≥–ª–∞–¥–∂—É—î —Ä—ñ–≤–µ–Ω—å –ø–∞–ª–∏–≤–∞, –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—á–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –∑–º—ñ–Ω–∏
    –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —Ä—ñ–∑–∫–∏–º —Å—Ç—Ä–∏–±–∫–∞–º –ø–æ–∫–∞–∑–∞–Ω—å.
    """
    global fuel_buffer, last_smoothed_fuel_percent, last_fuel_update_time_ms

    current_time_ms = time.ticks_ms()
    time_diff_sec = time.ticks_diff(current_time_ms, last_fuel_update_time_ms) / 1000.0

    # –í–∏–∑–Ω–∞—á–∞—î–º–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π —á–∞—Å–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–∏.
    # –Ø–∫—â–æ time_diff_sec –¥—É–∂–µ –º–∞–ª–µ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ UPDATE_INTERVAL_SEC, —â–æ–±
    # –æ–±–º–µ–∂–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –∑–º—ñ–Ω–∏ –Ω–µ –±—É–ª–æ –∑–∞–Ω–∞–¥—Ç–æ –∞–≥—Ä–µ—Å–∏–≤–Ω–∏–º.
    if time_diff_sec < (Settings.UPDATE_INTERVAL_SEC / 2.0):
        effective_time_diff_sec = Settings.UPDATE_INTERVAL_SEC
    else:
        effective_time_diff_sec = time_diff_sec

    new_raw_percent = get_raw_fuel_percent()

    # 1. –î–æ–¥–∞—î–º–æ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ –±—É—Ñ–µ—Ä–∞ —Ç–∞ –≤–∏–¥–∞–ª—è—î–º–æ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à–µ (FIFO).
    fuel_buffer.pop(0)
    fuel_buffer.append(new_raw_percent)

    # 2. –û–±—á–∏—Å–ª—é—î–º–æ —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –±—É—Ñ–µ—Ä–∞ (–∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è).
    current_smoothed_percent = sum(fuel_buffer) / len(fuel_buffer)

    # 3. –û–±–º–µ–∂—É—î–º–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å –∑–º—ñ–Ω–∏ –∑–Ω–∞—á–µ–Ω–Ω—è, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –ø—Ä–æ–π—à–æ–≤ –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π —á–∞—Å.
    if time_diff_sec > 0:
        max_change = Settings.FUEL_MAX_PERCENT_CHANGE_PER_SEC * effective_time_diff_sec
        if current_smoothed_percent > last_smoothed_fuel_percent + max_change:
            current_smoothed_percent = last_smoothed_fuel_percent + max_change
        elif current_smoothed_percent < last_smoothed_fuel_percent - max_change:
            current_smoothed_percent = last_smoothed_fuel_percent - max_change

    last_smoothed_fuel_percent = current_smoothed_percent
    last_fuel_update_time_ms = current_time_ms

    return last_smoothed_fuel_percent

def check_errors():
    """
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Å—Ç–∞–Ω –≤—Å—ñ—Ö –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏—Ö –¥–∞—Ç—á–∏–∫—ñ–≤ —Ç–∞ —Ä—ñ–≤–µ–Ω—å –ø–∞–ª–∏–≤–∞,
    –ø–æ–≤–µ—Ä—Ç–∞—é—á–∏ —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö –ê–ö–¢–ò–í–ù–ò–• –ø–æ–º–∏–ª–æ–∫.
    –í–∫–ª—é—á–∞—î –ª–æ–≥—ñ–∫—É –∑–∞—Ç—Ä–∏–º–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∏—Å–∫—É –º–∞—Å–ª–∞ —Ç–∞ –≥—ñ—Å—Ç–µ—Ä–µ–∑–∏—Å –¥–ª—è –ø–∞–ª–∏–≤–∞.
    """
    global engine_start_time_ms
    global is_low_fuel_active_by_hysteresis, last_smoothed_fuel_percent
    global is_engine_running_stable
    global last_stable_rpm_time_ms

    found_errors = [] # –°–ø–∏—Å–æ–∫ –¥–ª—è –∑–±–æ—Ä—É –≤—Å—ñ—Ö –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫ (–∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ç–∞ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∏—Ö).
    current_time_ms = time.ticks_ms()

    # –ó—á–∏—Ç—É—î–º–æ –æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ race conditions –∑ IRQ.
    current_rpm_safe = get_current_rpm_atomic()

    # --- 0. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ –¥–≤–∏–≥—É–Ω–∞ ---
    # –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ –¥–≤–∏–≥—É–Ω –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ, “ë—Ä—É–Ω—Ç—É—é—á–∏—Å—å –Ω–∞ RPM.
    if current_rpm_safe > Settings.MIN_RPM_FOR_STABLE_RUNNING:
        is_engine_running_stable = True
        last_stable_rpm_time_ms = current_time_ms # –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å, –∫–æ–ª–∏ RPM –±—É–≤ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–º.
        if engine_start_time_ms == 0:
            engine_start_time_ms = current_time_ms # –§—ñ–∫—Å—É—î–º–æ —á–∞—Å "—Å—Ö–æ–ø–ª–µ–Ω–Ω—è" –¥–≤–∏–≥—É–Ω–∞.
    else:
        # –Ø–∫—â–æ RPM –≤–ø–∞–≤, –Ω–µ —Å–∫–∏–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ –æ–¥—Ä–∞–∑—É, –∞ —á–µ–∫–∞—î–º–æ 2 —Å–µ–∫—É–Ω–¥–∏.
        # –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î —Ö–∏–±–Ω–∏–º —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥ —á–∞—Å –∫–æ—Ä–æ—Ç–∫–æ—á–∞—Å–Ω–∏—Ö –ø—Ä–æ—Å—ñ–¥–∞–Ω—å RPM.
        if time.ticks_diff(current_time_ms, last_stable_rpm_time_ms) > 2000:
            is_engine_running_stable = False
            # engine_start_time_ms —Å–∫–∏–¥–∞—î—Ç—å—Å—è –≤ –≥–æ–ª–æ–≤–Ω–æ–º—É —Ü–∏–∫–ª—ñ –ø—Ä–∏ —Ç—Ä–∏–≤–∞–ª—ñ–π –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—ñ–≤ —Ñ–æ—Ä—Å—É–Ω–∫–∏.

    # --- 1. –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ (–¥–∞—Ç—á–∏–∫–∏) ---
    # –î–∞—Ç—á–∏–∫–∏, —è–∫—ñ –∑–∞–∑–≤–∏—á–∞–π –∞–∫—Ç–∏–≤–Ω—ñ –Ω–∏–∑—å–∫–∏–º —Å–∏–≥–Ω–∞–ª–æ–º (0V) –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º—ñ.
    if BRAKE_FLUID_SENSOR_PIN.value() == 0:
        found_errors.append(Icons.ERROR_ICONS['BRAKE_FLUID'])
    if OVERHEAT_AND_LOW_COOLANT_SENSOR_PIN.value() == 0:
        found_errors.append(Icons.ERROR_ICONS['OVERHEAT_AND_LOW_COOLANT'])

    # –î–∞—Ç—á–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ —Ç–∏—Å–∫—É –º–∞—Å–ª–∞ (1.8 –±–∞—Ä) –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –ø–µ–≤–Ω–∏—Ö RPM.
    if current_rpm_safe > Settings.MIN_RPM_FOR_HIGH_PRESSURE_CHECK:
        if OIL_PRESSURE_1_8_SENSOR_PIN.value() == 0:
            found_errors.append(Icons.ERROR_ICONS['0_3_AND_1_8_PRESSURE_OIL'])

    # –î–∞—Ç—á–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ —Ç–∏—Å–∫—É –º–∞—Å–ª–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –ª–∏—à–µ –ø—ñ—Å–ª—è –∑–∞—Ç—Ä–∏–º–∫–∏ –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É –¥–≤–∏–≥—É–Ω–∞
    # —Ç–∞ –∫–æ–ª–∏ –¥–≤–∏–≥—É–Ω –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ.
    if OIL_PRESSURE_0_3_SENSOR_PIN.value() == 0:
        if is_engine_running_stable and engine_start_time_ms != 0:
            if time.ticks_diff(current_time_ms, engine_start_time_ms) > Settings.OIL_CHECK_DELAY_MS:
                found_errors.append(Icons.ERROR_ICONS['0_3_AND_1_8_PRESSURE_OIL'])

    # --- 2. –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞" (–∑ –≥—ñ—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º) ---
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥—ñ—Å—Ç–µ—Ä–µ–∑–∏—Å –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è.
    if is_low_fuel_active_by_hysteresis:
        # –Ø–∫—â–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –≤–∂–µ –∞–∫—Ç–∏–≤–Ω–µ, –¥–µ–∞–∫—Ç–∏–≤—É—î–º–æ –π–æ–≥–æ –ª–∏—à–µ –∫–æ–ª–∏ –ø–∞–ª–∏–≤–∞ —Å—Ç–∞–Ω–µ –∑–Ω–∞—á–Ω–æ –±—ñ–ª—å—à–µ.
        if last_smoothed_fuel_percent >= Settings.FUEL_HIGH_THRESHOLD_PERCENT:
            is_low_fuel_active_by_hysteresis = False
    else:
        # –Ø–∫—â–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–µ, –∞–∫—Ç–∏–≤—É—î–º–æ –π–æ–≥–æ, –∫–æ–ª–∏ –ø–∞–ª–∏–≤–∞ —Å—Ç–∞–Ω–µ –º–µ–Ω—à–µ –ø–æ—Ä–æ–≥–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è.
        if last_smoothed_fuel_percent <= Settings.FUEL_LOW_THRESHOLD_PERCENT:
            is_low_fuel_active_by_hysteresis = True

    if is_low_fuel_active_by_hysteresis:
        found_errors.append(Icons.ERROR_ICONS['LOW_FUEL'])

    # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω—ñ –ø–æ–º–∏–ª–∫–∏, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —ó—Ö —Å–ø–∏—Å–æ–∫.
    if found_errors:
        return found_errors

    # –Ø–∫—â–æ –ø–æ–º–∏–ª–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É —ñ–∫–æ–Ω–∫—É "NONE".
    return [Icons.ERROR_ICONS['NONE']]

def load_persistent_data():
    """
    –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ –¥–∞–Ω—ñ TRIP —Ç–∞ PERS –∑ —Ñ–∞–π–ª—É –Ω–∞ Flash –ø–∞–º'—è—Ç—ñ.
    –î–∞–Ω—ñ –≤–∫–ª—é—á–∞—é—Ç—å –Ω–∞–∫–æ–ø–∏—á–µ–Ω–µ –ø–∞–ª–∏–≤–æ —Ç–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–±—ñ–≥—É —Ç–∞ –ø–æ—Ç–æ—á–Ω–æ—ó –ø–æ—ó–∑–¥–∫–∏.
    """
    global persistent_trip_fuel_L, persistent_trip_distance_km, trip_fuel_consumed_L, trip_distance_travelled_km, file_error_count
    try:
        with open(Settings.TRIP_DATA_FILE, 'r') as f:
            lines = f.readlines()
            # –û—á—ñ–∫—É—î–º–æ 4 —Ä—è–¥–∫–∏: persistent fuel, persistent distance, trip fuel, trip distance.
            if len(lines) >= 4:
                persistent_trip_fuel_L = float(lines[0].strip())
                persistent_trip_distance_km = float(lines[1].strip())
                trip_fuel_consumed_L = float(lines[2].strip())
                trip_distance_travelled_km = float(lines[3].strip())
            else:
                # –Ø–∫—â–æ —Ñ–∞–π–ª –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–π –∞–±–æ –Ω–µ–ø–æ–≤–Ω–∏–π, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –Ω—É–ª—è–º–∏.
                print("‚ö†Ô∏è Persistent data file incomplete, initializing with 0.")
                persistent_trip_fuel_L = 0.0
                persistent_trip_distance_km = 0.0
                trip_fuel_consumed_L = 0.0
                trip_distance_travelled_km = 0.0
    except Exception as e:
        # –£ –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ —Ñ–∞–π–ª—É, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –Ω—É–ª—è–º–∏ —Ç–∞ –∑–±—ñ–ª—å—à—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫.
        print(f"‚ö†Ô∏è Load persistent data error: {e}. Initializing with 0.")
        persistent_trip_fuel_L = 0.0
        persistent_trip_distance_km = 0.0
        trip_fuel_consumed_L = 0.0
        trip_distance_travelled_km = 0.0
        file_error_count += 1

def save_persistent_data():
    """
    –ó–±–µ—Ä—ñ–≥–∞—î –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ –¥–∞–Ω—ñ TRIP —Ç–∞ PERS –¥–æ —Ñ–∞–π–ª—É –Ω–∞ Flash –ø–∞–º'—è—Ç—ñ
    —á–µ—Ä–µ–∑ –ø–µ–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª —á–∞—Å—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∞—Ç–æ–º–∞—Ä–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º
    (—Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª -> –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è). –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—é —Ñ–∞–π–ª—É
    —É —Ä–∞–∑—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∂–∏–≤–ª–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Å—É.
    """
    global last_persistent_save_time_ms, file_error_count
    now = time.ticks_ms()
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –ª–∏—à–µ —è–∫—â–æ –º–∏–Ω—É–≤ –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª —á–∞—Å—É.
    if time.ticks_diff(now, last_persistent_save_time_ms) >= Settings.PERSISTENT_SAVE_INTERVAL_MS:
        try:
            # 1. –ó–∞–ø–∏—Å—É—î–º–æ –¥–∞–Ω—ñ –≤ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª.
            with open(Settings.TRIP_DATA_TEMP, 'w') as f:
                f.write(str(persistent_trip_fuel_L) + '\n')
                f.write(str(persistent_trip_distance_km) + '\n')
                f.write(str(trip_fuel_consumed_L) + '\n')
                f.write(str(trip_distance_travelled_km) + '\n')

            # 2. –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π —Ä–µ–∑–µ—Ä–≤–Ω–∏–π —Ñ–∞–π–ª (—è–∫—â–æ —ñ—Å–Ω—É—î).
            try: os.remove(Settings.TRIP_DATA_BACKUP)
            except OSError: pass # –Ü–≥–Ω–æ—Ä—É—î–º–æ, —è–∫—â–æ —Ñ–∞–π–ª—É –Ω–µ–º–∞—î.

            # 3. –ü–µ—Ä–µ–π–º–µ–Ω–æ–≤—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª –¥–∞–Ω–∏—Ö –≤ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π.
            try: os.rename(Settings.TRIP_DATA_FILE, Settings.TRIP_DATA_BACKUP)
            except OSError: pass # –Ü–≥–Ω–æ—Ä—É—î–º–æ, —è–∫—â–æ —Ñ–∞–π–ª—É –Ω–µ–º–∞—î.

            # 4. –ü–µ—Ä–µ–π–º–µ–Ω–æ–≤—É—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª –≤ –æ—Å–Ω–æ–≤–Ω–∏–π —Ñ–∞–π–ª –¥–∞–Ω–∏—Ö.
            os.rename(Settings.TRIP_DATA_TEMP, Settings.TRIP_DATA_FILE)
            last_persistent_save_time_ms = now # –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.
        except Exception as e:
            # –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.
            print(f"‚ö†Ô∏è Save persistent data error: {e}")
            file_error_count += 1 # –ó–±—ñ–ª—å—à—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫.

def reset_persistent_trip():
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫–∏–¥–∞—î –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ PERS (–¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–æ–±—ñ–≥—É —Ç–∞ –≤–∏—Ç—Ä–∞—Ç–∏),
    —è–∫—â–æ –¥–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç—É –≤—ñ–¥—Å—Ç–∞–Ω—ñ, –≤–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ –≤ Settings.
    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∞—Ç–æ–º–∞—Ä–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.
    """
    global persistent_trip_fuel_L, persistent_trip_distance_km, file_error_count
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –¥–æ—Å—è–≥–Ω—É—Ç–æ –ø–æ—Ä–æ–≥–æ–≤–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è.
    if persistent_trip_distance_km >= Settings.RESET_PERSISTENT_TRIP_DISTANCE_KM:
        print(f"üîÑ Reset persistent trip at {persistent_trip_fuel_L:.2f}L / {persistent_trip_distance_km:.2f}km")
        # –°–∫–∏–¥–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è PERS.
        persistent_trip_fuel_L = 0.0
        persistent_trip_distance_km = 0.0
        try:
            # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π –∞—Ç–æ–º–∞—Ä–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è,
            # —â–æ–± –æ–Ω–æ–≤–∏—Ç–∏ —Ñ–∞–π–ª –∑ –Ω—É–ª—å–æ–≤–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ PERS.
            with open(Settings.TRIP_DATA_TEMP, 'w') as f:
                f.write(str(persistent_trip_fuel_L) + '\n')
                f.write(str(persistent_trip_distance_km) + '\n')
                # –í–∞–∂–ª–∏–≤–æ: —Ç–∞–∫–æ–∂ –∑–∞–ø–∏—Å—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è TRIP, —â–æ–± —ó—Ö –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏.
                f.write(str(trip_fuel_consumed_L) + '\n')
                f.write(str(trip_distance_travelled_km) + '\n')

            try: os.remove(Settings.TRIP_DATA_BACKUP)
            except OSError: pass
            try: os.rename(Settings.TRIP_DATA_FILE, Settings.TRIP_DATA_BACKUP)
            except OSError: pass
            os.rename(Settings.TRIP_DATA_TEMP, Settings.TRIP_DATA_FILE)
        except OSError as e:
            print(f"‚ö†Ô∏è Reset persistent trip file error: {e}")
            file_error_count += 1

# -------------------------------------------------------------------------
# 6. –û–ë–†–û–ë–ù–ò–ö–ò –ü–ï–†–ï–†–ò–í–ê–ù–¨ (IRQ - INTERRUPT REQUEST)
#    –§—É–Ω–∫—Ü—ñ—ó, —è–∫—ñ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞–ø–∞—Ä–∞—Ç–Ω–∏–º –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è–º
#    –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞–Ω—É –Ω–∞ –≤—Ö—ñ–¥–Ω–∏—Ö –ø—ñ–Ω–∞—Ö. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ
#    —Ç–∞ —Å–≤–æ—î—á–∞—Å–Ω–æ–≥–æ –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö.
# -------------------------------------------------------------------------

def injector_irq_handler(pin):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è –¥–ª—è —Å–∏–≥–Ω–∞–ª—É —Ñ–æ—Ä—Å—É–Ω–∫–∏.
    –í–∏–∑–Ω–∞—á–∞—î —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—ñ–≤ —Ñ–æ—Ä—Å—É–Ω–∫–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∏—Ç—Ä–∞—Ç–∏ –ø–∞–ª–∏–≤–∞
    —Ç–∞ –ø–µ—Ä—ñ–æ–¥ –º—ñ–∂ —ñ–º–ø—É–ª—å—Å–∞–º–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –æ–±–µ—Ä—Ç—ñ–≤ –¥–≤–∏–≥—É–Ω–∞ (RPM).
    """
    global last_pulse_edge_us, total_pulse_time_us, rpm, current_inj_period_us
    global is_engine_running, last_inj_activity_time_ms
    global last_inj_irq_time_us, last_inj_start_us
    global dynamic_dead_time_us

    # üõ°Ô∏è –ê—Ç–æ–º–∞—Ä–Ω–∏–π –±–ª–æ–∫: —Ç–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥–∫–ª—é—á–∞—î–º–æ –≤—Å—ñ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è,
    # —â–æ–± –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –±–µ–∑–ø–µ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö, —è–∫—ñ
    # —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –≤ –≥–æ–ª–æ–≤–Ω–æ–º—É —Ü–∏–∫–ª—ñ.
    irq_state = disable_irq()
    try:
        current_time_us = time.ticks_us()
        pin_state = pin.value()

        # –î–µ–±–∞—É–Ω—Å: —ñ–≥–Ω–æ—Ä—É—î–º–æ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è IRQ, —è–∫—â–æ –≤–æ–Ω–æ –≤—ñ–¥–±—É–ª–æ—Å—è –∑–∞–Ω–∞–¥—Ç–æ —à–≤–∏–¥–∫–æ
        # –ø—ñ—Å–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ, —â–æ–± —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω–∏–π —à—É–º.
        if time.ticks_diff(current_time_us, last_inj_irq_time_us) < 100:
            return
        last_inj_irq_time_us = current_time_us

        # --- –û–ë–†–û–ë–ö–ê FALLING EDGE (—ñ–º–ø—É–ª—å—Å —Ñ–æ—Ä—Å—É–Ω–∫–∏ –í–ö–õ–Æ–ß–ò–í–°–Ø) ---
        if pin_state == 0:
            # 1. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ RPM (–æ–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞).
            # RPM —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –∑ –ø–µ—Ä—ñ–æ–¥—É –º—ñ–∂ *–ø–æ—á–∞—Ç–∫–∞–º–∏* –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö —ñ–º–ø—É–ª—å—Å—ñ–≤ —Ñ–æ—Ä—Å—É–Ω–∫–∏.
            if last_inj_start_us != 0: # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ —Ü–µ –Ω–µ –ø–µ—Ä—à–∏–π —ñ–º–ø—É–ª—å—Å –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É/—Å–∫–∏–¥–∞–Ω–Ω—è.
                period_between_pulses_us = time.ticks_diff(current_time_us, last_inj_start_us)

                # –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–µ—Ä—ñ–æ–¥, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –Ω–µ—Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏—Ö RPM (—à—É–º, –¥—É–∂–µ –≤–∏—Å–æ–∫—ñ/–Ω–∏–∑—å–∫—ñ –æ–±–µ—Ä—Ç–∏).
                if Settings.MIN_INJ_PERIOD_FOR_RPM_US < period_between_pulses_us < Settings.MAX_INJ_PERIOD_FOR_RPM_US:
                    # –§–æ—Ä–º—É–ª–∞ RPM: (–º—ñ–∫—Ä–æ—Å–µ–∫—É–Ω–¥_–≤_—Ö–≤–∏–ª–∏–Ω—ñ / –ø–µ—Ä—ñ–æ–¥_–º–∫—Å) / —ñ–º–ø—É–ª—å—Å—ñ–≤_–Ω–∞_–æ–±–µ—Ä—Ç.
                    rpm_calculated = (Settings.RPM_BASE_FACTOR // period_between_pulses_us) // Settings.RPM_PULSES_PER_ENGINE_REVOLUTION

                    # –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è RPM.
                    if Settings.MIN_DISPLAY_RPM <= rpm_calculated <= Settings.MAX_DISPLAY_RPM:
                        rpm = rpm_calculated
                    else:
                        rpm = 0 # –í—ñ–¥–∫–∏–¥–∞—î–º–æ RPM, —è–∫—ñ –≤–∏—Ö–æ–¥—è—Ç—å –∑–∞ –º–µ–∂—ñ –æ—á—ñ–∫—É–≤–∞–Ω–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É.
                else:
                    rpm = 0 # –ü–µ—Ä—ñ–æ–¥ –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ –º–µ–∂—ñ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É (–º–æ–∂–µ –±—É—Ç–∏ —à—É–º –∞–±–æ –∑—É–ø–∏–Ω–∫–∞).
            else:
                rpm = 0 # –Ø–∫—â–æ —Ü–µ –ø–µ—Ä—à–∏–π —ñ–º–ø—É–ª—å—Å, RPM —â–µ –Ω–µ –º–æ–∂–Ω–∞ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏.

            last_inj_start_us = current_time_us # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å –ø–æ—á–∞—Ç–∫—É —Ü—å–æ–≥–æ —ñ–º–ø—É–ª—å—Å—É –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É RPM.

            # 2. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—É.
            last_pulse_edge_us = current_time_us # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å –ø–æ—á–∞—Ç–∫—É —ñ–º–ø—É–ª—å—Å—É.

            # 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –¥–≤–∏–≥—É–Ω–∞.
            last_inj_activity_time_ms = time.ticks_ms() # –§—ñ–∫—Å—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ñ–æ—Ä—Å—É–Ω–∫–∏.
            is_engine_running = True # –í–∫–∞–∑—É—î–º–æ, —â–æ –¥–≤–∏–≥—É–Ω –∞–∫—Ç–∏–≤–Ω–æ –ø—Ä–∞—Ü—é—î.

        # --- –û–ë–†–û–ë–ö–ê RISING EDGE (—ñ–º–ø—É–ª—å—Å —Ñ–æ—Ä—Å—É–Ω–∫–∏ –í–ò–ú–ö–ù–£–í–°–Ø) ---
        elif pin_state == 1 and last_pulse_edge_us > 0:
            # 1. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—É (ON-—á–∞—Å —Ñ–æ—Ä—Å—É–Ω–∫–∏).
            raw_duration = time.ticks_diff(current_time_us, last_pulse_edge_us)

            # –í—ñ–¥–Ω—ñ–º–∞—î–º–æ "–º–µ—Ä—Ç–≤—É –∑–æ–Ω—É" —Ñ–æ—Ä—Å—É–Ω–∫–∏ —Ç–∞ –∑–∞–±–µ–∑–ø–µ—á—É—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å.
            # –¶–µ –∫–æ—Ä–∏–≥—É—î —Ñ–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å, –∫–æ–ª–∏ —Ñ–æ—Ä—Å—É–Ω–∫–∞ –±—É–ª–∞ —Ñ—ñ–∑–∏—á–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ—é.
            actual_duration = max(0, raw_duration - dynamic_dead_time_us)

            # –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫—ñ/—à—É–º–æ–≤—ñ —ñ–º–ø—É–ª—å—Å–∏ –∑–∞ —à–∏—Ä–∏–Ω–æ—é (ON-—á–∞—Å).
            if actual_duration < Settings.MIN_INJ_PULSE_WIDTH_FILTER_US:
                last_pulse_edge_us = 0 # –°–∫–∏–¥–∞—î–º–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–¥–∞–ª—å—à–∏—Ö –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤.
                return

            # 2. –ù–∞–∫–æ–ø–∏—á–µ–Ω–Ω—è —á–∞—Å—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä—Å—É–Ω–æ–∫ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∏—Ç—Ä–∞—Ç–∏ –ø–∞–ª–∏–≤–∞.
            total_pulse_time_us += actual_duration # –î–æ–¥–∞—î–º–æ –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä—Å—É–Ω–æ–∫.
            current_inj_period_us = actual_duration # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —ñ–º–ø—É–ª—å—Å—É (–ø–æ —Å—É—Ç—ñ, –π–æ–≥–æ —à–∏—Ä–∏–Ω—É).

            last_pulse_edge_us = 0 # –°–∫–∏–¥–∞—î–º–æ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—É.
    finally:
        enable_irq(irq_state) # üõ°Ô∏è –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –±–ª–æ–∫—É: –∑–Ω–æ–≤—É –≤–º–∏–∫–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è.

def vss_irq_handler(pin):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ (VSS).
    –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î —ñ–º–ø—É–ª—å—Å–∏ VSS –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –ø—Ä–æ–π–¥–µ–Ω–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ —Ç–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ.
    """
    global vss_pulse_count, last_vss_pulse_us, last_vss_activity_time_ms

    # üõ°Ô∏è –ê—Ç–æ–º–∞—Ä–Ω–∏–π –±–ª–æ–∫: –∑–∞—Ö–∏—Å—Ç —Å–ø—ñ–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö.
    irq_state = disable_irq()
    try:
        now = time.ticks_us()

        # –î–µ–±–∞—É–Ω—Å: —ñ–≥–Ω–æ—Ä—É—î–º–æ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è IRQ, —è–∫—â–æ –≤–æ–Ω–æ –≤—ñ–¥–±—É–ª–æ—Å—è –∑–∞–Ω–∞–¥—Ç–æ —à–≤–∏–¥–∫–æ.
        if time.ticks_diff(now, last_vss_pulse_us) > Settings.VSS_DEBOUNCE_US:
            vss_pulse_count += 1
            last_vss_activity_time_ms = time.ticks_ms() # –§—ñ–∫—Å—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å VSS.
            last_vss_pulse_us = now
    finally:
        enable_irq(irq_state) # üõ°Ô∏è –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –±–ª–æ–∫—É.

# -------------------------------------------------------------------------
# 7. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –°–ò–°–¢–ï–ú–ò
#    –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º–∏: –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è OLED,
#    –ø–µ—Ä–≤–∏–Ω–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä—ñ–≤, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–∞ –ø–æ—á–∞—Ç–∫–æ–≤–∞
#    –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É.
# -------------------------------------------------------------------------

oled_status = "OFF" # –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å OLED –¥–∏—Å–ø–ª–µ—è.
oled = None         # –û–±'—î–∫—Ç OLED –¥–∏—Å–ø–ª–µ—è.
# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è I2C —à–∏–Ω–∏.
i2c = I2C(0, scl=Pin(Settings.PIN_I2C_SCL), sda=Pin(Settings.PIN_I2C_SDA), freq=Settings.I2C_FREQ)

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è OLED –¥–∏—Å–ø–ª–µ—è.
if sh1107:
    i2c_devices = i2c.scan() # –°–∫–∞–Ω—É—î–º–æ I2C —à–∏–Ω—É –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤.
    if Settings.OLED_ADDR_HEX in i2c_devices: # –Ø–∫—â–æ OLED –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∞–¥—Ä–µ—Å–æ—é.
        try:
            oled = sh1107.SH1107_I2C(128, 128, i2c, address=Settings.OLED_ADDR_HEX, rotate=0)
            oled_status = "OK"
            oled.contrast(Settings.OLED_CONTRAST) # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç –¥–∏—Å–ø–ª–µ—è.

            # --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ó–ì–õ–ê–î–ñ–ï–ù–ù–Ø –ü–ê–õ–ò–í–ê ---
            # –ó–∞–ø–æ–≤–Ω—é—î–º–æ –±—É—Ñ–µ—Ä —Ä—ñ–≤–Ω—è –ø–∞–ª–∏–≤–∞ –ø–æ—á–∞—Ç–∫–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º.
            initial_fuel_percent = get_raw_fuel_percent()
            for i in range(Settings.FUEL_BUFFER_SIZE):
                fuel_buffer[i] = initial_fuel_percent
            last_smoothed_fuel_percent = initial_fuel_percent

            # --- –ü–ï–†–í–ò–ù–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ü–û–ú–ò–õ–û–ö –ü–†–ò –ó–ê–ü–£–°–ö–£ ---
            initial_full_errors = check_errors() # –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –ø–æ–º–∏–ª–∫–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ.
            # –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏, —â–æ–± –≤–∏—Ä—ñ—à–∏—Ç–∏, —á–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –µ–∫—Ä–∞–Ω STATUS_OK.
            initial_critical_errors = [err for err in initial_full_errors if err['text'] in ALL_SOUND_TRIGGERING_ERROR_TEXTS]

            if not initial_critical_errors: # –Ø–∫—â–æ –ö–†–ò–¢–ò–ß–ù–ò–• –ø–æ–º–∏–ª–æ–∫ –Ω–µ–º–∞—î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ.
                # –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–∏–≤—ñ—Ç–∞–ª—å–Ω–∏–π –µ–∫—Ä–∞–Ω STATUS_OK.
                oled.fill(0)
                if 'STATUS_OK' in Icons.ERROR_ICONS and Icons.ERROR_ICONS['STATUS_OK']['icon'] is not None:
                     fd = Icons.ERROR_ICONS['STATUS_OK']
                     ok_icon_fb = framebuf.FrameBuffer(fd['icon'], fd['width'], fd['height'], framebuf.MONO_HLSB)
                     oled.blit(ok_icon_fb, fd['icon_pos'][0], fd['icon_pos'][1])
                oled.show()
                time.sleep(Settings.STARTUP_OK_SCREEN_DURATION_SEC)
                # –ü–æ—á–∏–Ω–∞—î–º–æ –∑ —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞–Ω—É, –¥–∞–ª—ñ –ª–æ–≥—ñ–∫–∞ –≤ —Ü–∏–∫–ª—ñ –æ–±—Ä–æ–±–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ñ –ø–æ–º–∏–ª–∫–∏.
                active_errors = [Icons.ERROR_ICONS['NONE']]
                current_display_mode = "MAIN" # –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–µ–∂–∏–º –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
            else:
                # –Ø–∫—â–æ —î –ö–†–ò–¢–ò–ß–ù–Ü –ø–æ–º–∏–ª–∫–∏, –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑—É—î–º–æ —ó—Ö.
                active_errors = initial_critical_errors[:] # –ö–æ–ø—ñ—é—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏.
                if 'WARNING' in Icons.ERROR_ICONS: # –î–æ–¥–∞—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É —ñ–∫–æ–Ω–∫—É –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –≤–∏–∑–Ω–∞—á–µ–Ω–∞.
                    active_errors.append(Icons.ERROR_ICONS['WARNING'])

                # –ê–∫—Ç–∏–≤—É—î–º–æ –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫.
                if pwm_speaker:
                    sensor_alarm_active = True
                    alarm_phase = 0
                    alarm_phase_start_time_ms = 0
                    if pwm_speaker.freq() != Settings.ALARM_SEQUENCE[0][1]:
                         pwm_speaker.freq(Settings.ALARM_SEQUENCE[0][1])
                    pwm_speaker.duty_u16(32768)
                    current_speaker_freq = Settings.ALARM_SEQUENCE[0][1]
                    current_speaker_duty = 32768

                # –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–µ—Ä—à—É –∫—Ä–∏—Ç–∏—á–Ω—É –ø–æ–º–∏–ª–∫—É –∑—ñ —Å–ø–∏—Å–∫—É –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ.
                oled.fill(0)
                icon_to_draw = active_errors[0]
                if icon_to_draw['icon'] is not None:
                    icon_fb = framebuf.FrameBuffer(icon_to_draw['icon'], icon_to_draw['width'], icon_to_draw['height'], framebuf.MONO_HLSB)
                    oled.blit(icon_fb, icon_to_draw['icon_pos'][0], icon_to_draw['icon_pos'][1])
                oled.show()
                time.sleep(Settings.STARTUP_ERROR_SCREEN_DURATION_SEC)
                current_display_mode = "ERROR_CYCLE" # –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–µ–∂–∏–º –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
        except Exception as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó OLED: {e}")
            oled_status = "OFF"; oled = None # –í–∏–º–∏–∫–∞—î–º–æ OLED, —è–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞.
    else:
        print("OLED –¥–∏—Å–ø–ª–µ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
else:
    print("–î—Ä–∞–π–≤–µ—Ä sh1107 –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.")

# –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω—å –¥–ª—è –ø—ñ–Ω—ñ–≤ —Ñ–æ—Ä—Å—É–Ω–∫–∏ —Ç–∞ –¥–∞—Ç—á–∏–∫–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ.
# INJ_PIN: —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –Ω–∞ –æ–±–∏–¥–≤–∞ —Ñ—Ä–æ–Ω—Ç–∏ (RISING | FALLING) –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—É.
INJ_PIN.irq(trigger=Pin.IRQ_RISING | Pin.IRQ_FALLING, handler=injector_irq_handler)
# VSS_PIN: —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –Ω–∞ FALLING EDGE (–∞–±–æ RISING, –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –¥–∞—Ç—á–∏–∫–∞) –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É —ñ–º–ø—É–ª—å—Å—ñ–≤.
VSS_PIN.irq(trigger=Pin.IRQ_FALLING, handler=vss_irq_handler)

load_persistent_data() # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–∫–æ–ø–∏—á–µ–Ω—ñ –¥–∞–Ω—ñ –ø–æ—ó–∑–¥–æ–∫ –∑ —Ñ–∞–π–ª—É.
try: os.remove(Settings.TRIP_DATA_TEMP) # –í–∏–¥–∞–ª—è—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª, —è–∫—â–æ –≤—ñ–Ω –∑–∞–ª–∏—à–∏–≤—Å—è –≤—ñ–¥ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–ø—É—Å–∫—É.
except OSError: pass

if oled_status == "OK" and oled:
    oled.fill(0); oled.show() # –û—á–∏—â–∞—î–º–æ –¥–∏—Å–ø–ª–µ–π –ø—ñ—Å–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤.

# -------------------------------------------------------------------------
# 8. –õ–û–ì–Ü–ö–ê –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –ï–ö–†–ê–ù–Ü–í
#    –§—É–Ω–∫—Ü—ñ—ó, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∑–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ OLED –¥–∏—Å–ø–ª–µ—ó.
# -------------------------------------------------------------------------

def draw_main_screen(oled_obj, current_distance_km_interval, current_volume_L_interval, current_speed_kmh, interval_sec, display_value=0.0):
    """
    –ú–∞–ª—é—î –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω –±–æ—Ä—Ç–æ–≤–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞:
    –ú–∏—Ç—Ç—î–≤–∞ –≤–∏—Ç—Ä–∞—Ç–∞ –ø–∞–ª–∏–≤–∞ (L/H –∞–±–æ L/100KM) –∑ —Ä–∞–º–∫–æ—é,
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ç–æ—á–Ω–æ—ó –ø–æ—ó–∑–¥–∫–∏ (TRIP) —Ç–∞ –∑–∞–≥–∞–ª—å–Ω–æ—ó (PERS),
    –∞ —Ç–∞–∫–æ–∂ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Ñ–∞–π–ª–æ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫.
    """
    global trip_fuel_consumed_L, trip_distance_travelled_km
    global persistent_trip_fuel_L, persistent_trip_distance_km
    global blink_on, file_error_count

    # --- 1. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –≤–∏—Ç—Ä–∞—Ç–∏ (L/H –∞–±–æ L/100KM) ---
    raw_value = display_value # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–∂–µ –∑–≥–ª–∞–¥–∂–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.

    # –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ –º–æ–∂–Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ L/100KM (–ø–æ—Ç—Ä—ñ–±–Ω–∞ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å —Ç–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å).
    can_show_l100km = (current_speed_kmh >= Settings.MIN_SPEED_FOR_L100KM_KMH) and \
                      (trip_distance_travelled_km >= Settings.MIN_DISTANCE_FOR_L100KM_KM)

    value_str = ""
    text_size_main = Settings.MAIN_VALUE_FONT_SIZE

    # –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è: "-.--" –¥–ª—è —Å—Ç–∞—Ü—ñ–æ–Ω–∞—Ä–Ω–æ–≥–æ —Å—Ç–∞–Ω—É, "EEEE" –¥–ª—è –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –ª—ñ–º—ñ—Ç—É.
    if raw_value < Settings.STATIONARY_THRESHOLD:
        value_str = "-.--"
    elif raw_value > Settings.MAX_DISPLAY_L100KM_VALUE:
        value_str = "EEEE"
    else:
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –∑–Ω–∞—á–µ–Ω—å 0.00 - 99.9.
        if raw_value < 10.0:
            value_str = "{: >4.2f}".format(raw_value) # –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "1.23".
        else:
            value_str = "{: >4.1f}".format(raw_value) # –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "12.3".

    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–æ–∑–∏—Ü—ñ—ó —Ç–∞ —Ä–æ–∑–º—ñ—Ä—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è.
    main_val_x_pos = (128 - len(value_str) * 8 * text_size_main) // 2 + Settings.MAIN_VALUE_X_OFFSET
    main_val_y_pos = Settings.MAIN_VALUE_Y_POS
    main_val_width = len(value_str) * 8 * text_size_main
    main_val_height = 8 * text_size_main

    oled_obj.large_text(value_str, main_val_x_pos, main_val_y_pos, text_size_main, 1)

    # --- 2. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ–¥–∏–Ω–∏—Ü—å –≤–∏–º—ñ—Ä—É (L/H –∞–±–æ L/100KM) ---

    unit_text = "L/H"
    if can_show_l100km:
        unit_text = "L/100KM"

    # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–æ–∑–∏—Ü—ñ—ó —Ç–∞ —Ä–æ–∑–º—ñ—Ä—É –æ–¥–∏–Ω–∏—Ü—å –≤–∏–º—ñ—Ä—É –¥–ª—è —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ—Å–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è.
    unit_text_size_x = Settings.MAIN_UNIT_FONT_SIZE_X
    unit_text_size_y = Settings.MAIN_UNIT_FONT_SIZE_Y
    unit_y_pos = main_val_y_pos + main_val_height + Settings.MAIN_UNIT_Y_OFFSET
    unit_text_width = len(unit_text) * 2 * unit_text_size_x
    unit_text_height = 8 * unit_text_size_y
    unit_x_pos = (128 - unit_text_width) // 2 + Settings.MAIN_VALUE_X_OFFSET

    oled_obj.stretched_text(unit_text, unit_x_pos, unit_y_pos, unit_text_size_x, unit_text_size_y, 1)

    # --- 3. –ú–∞–ª—é–≤–∞–Ω–Ω—è —Ä–∞–º–∫–∏ –Ω–∞–≤–∫–æ–ª–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–∫–∞–∑–Ω–∏–∫–∞ —Ç–∞ –æ–¥–∏–Ω–∏—Ü—å ---
    padding = Settings.MAIN_FRAME_PADDING_PX
    radius = Settings.MAIN_FRAME_RADIUS_PX

    # –û–±—á–∏—Å–ª–µ–Ω–Ω—è –æ–±'—î–¥–Ω–∞–Ω–∏—Ö –≥—Ä–∞–Ω–∏—Ü—å, —è–∫—ñ —Ä–∞–º–∫–∞ –ø–æ–≤–∏–Ω–Ω–∞ –æ—Ö–æ–ø–ª—é–≤–∞—Ç–∏.
    frame_x_min = min(main_val_x_pos, unit_x_pos)
    frame_x_max = max(main_val_x_pos + main_val_width, unit_x_pos + unit_text_width)
    frame_y_min = main_val_y_pos
    frame_y_max = unit_y_pos + unit_text_height

    # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–∞ —Ä–æ–∑–º—ñ—Ä–∏ —Ä–∞–º–∫–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –≤—ñ–¥—Å—Ç—É–ø—É (padding).
    frame_x = frame_x_min - padding
    frame_y = frame_y_min - padding
    frame_w = (frame_x_max - frame_x_min) + 2 * padding
    frame_h = (frame_y_max - frame_y_min) + 2 * padding

    oled_obj.round_rect(frame_x, frame_y, frame_w, frame_h, radius, 1)

    # --- 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ PERS (—Å–µ—Ä–µ–¥–Ω—è –≤–∏—Ç—Ä–∞—Ç–∞ L/100KM) ---
    avg_p_val = 0.0
    if persistent_trip_distance_km > Settings.MIN_PERS_DISPLAY_DISTANCE_KM:
        # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å–µ—Ä–µ–¥–Ω—å–æ—ó –≤–∏—Ç—Ä–∞—Ç–∏ PERS.
        avg_p_val = (persistent_trip_fuel_L / persistent_trip_distance_km) * 100.0

    # –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –¥–ª—è PERS.
    if avg_p_val > 0.0 and avg_p_val <= Settings.MAX_DISPLAY_L100KM_VALUE:
        pers_avg_str = "{:>{}.1f}".format(avg_p_val, Settings.PERS_L100KM_DISPLAY_WIDTH)
    else:
        pers_avg_str = "{:>{}}".format("----", Settings.PERS_L100KM_DISPLAY_WIDTH)

    pers_txt = "{} L/100KM".format(pers_avg_str)
    oled_obj.stretched_text(pers_txt, Settings.STAT_TEXT_X_POS, Settings.PERS_STAT_Y_POS, 1, 2)

    # --- 5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ TRIP (–Ω–∞–∫–æ–ø–∏—á–µ–Ω—ñ –ª—ñ—Ç—Ä–∏ —Ç–∞ –∫—ñ–ª–æ–º–µ—Ç—Ä–∏) ---
    # –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–∞–ª–∏–≤–∞ TRIP.
    f_str_val = trip_fuel_consumed_L if trip_fuel_consumed_L > 0.05 else None
    f_str_display = "{:>{}.1f}".format(f_str_val, Settings.TRIP_FUEL_DISPLAY_WIDTH) if f_str_val is not None else "{:>{}}".format("----", Settings.TRIP_FUEL_DISPLAY_WIDTH)

    # –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–∞–Ω—ñ TRIP.
    d_str_val = int(trip_distance_travelled_km) if trip_distance_travelled_km > 0.1 else None
    d_str_display = "{:>{}.0f}".format(d_str_val, Settings.TRIP_DISTANCE_DISPLAY_WIDTH) if d_str_val is not None else "{:>{}}".format("---", Settings.TRIP_DISTANCE_DISPLAY_WIDTH)

    trip_txt = "{}L  {}KM".format(f_str_display, d_str_display)
    oled_obj.stretched_text(trip_txt, Settings.STAT_TEXT_X_POS, Settings.TRIP_STAT_Y_POS, 1, 2)

    # --- 6. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Ñ–∞–π–ª–æ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫ (—è–∫—â–æ —î) ---
    if file_error_count > 0:
        error_display_text = f"FE:{file_error_count}" # "FE" —Å–∫–æ—Ä–æ—á–µ–Ω–æ –≤—ñ–¥ "File Error".
        text_w = len(error_display_text) * 8 # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —à—Ä–∏—Ñ—Ç 8px –∑–∞ —à–∏—Ä–∏–Ω–æ—é.
        oled_obj.text(error_display_text, 128 - text_w - 4, 0, 1) # –£ –≤–µ—Ä—Ö–Ω—å–æ–º—É –ø—Ä–∞–≤–æ–º—É –∫—É—Ç—ñ.

    # –í–∏–∫–ª–∏–∫–∞–µ–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞–ø—Ä—É–≥–∏.
    draw_batt_icon(oled_obj, 7, 42, current_battery_voltage, time.ticks_ms())


def draw_special_screen(oled_obj, speed_kmh, rpm_val, fuel_percent_val):
    """
    –ú–∞–ª—é—î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –µ–∫—Ä–∞–Ω –∑ –ø–æ—Ç–æ—á–Ω–æ—é —à–≤–∏–¥–∫—ñ—Å—Ç—é, –æ–±–µ—Ä—Ç–∞–º–∏ –¥–≤–∏–≥—É–Ω–∞ —Ç–∞ –∑–∞–ª–∏—à–∫–æ–º –ø–∞–ª–∏–≤–∞.
    """
    global voltage_adc, file_error_count, avg_inj_ms

    oled_obj.fill(0) # –û—á–∏—â–∞—î–º–æ –¥–∏—Å–ø–ª–µ–π.

    # 1. –®–≤–∏–¥–∫—ñ—Å—Ç—å (KMH)
    speed_display = "---" if speed_kmh <= 0 else f"{int(speed_kmh):3d}"
    speed_text = f"{speed_display}KMH"
    oled_obj.stretched_text(speed_text, Settings.SP_SCR_SPEED_X, Settings.SP_SCR_SPEED_Y,
                           Settings.SP_SCR_SPEED_FONT_SIZE, Settings.SP_SCR_SPEED_FONT_SIZE)

    # 2. –ù–∞–ø—Ä—É–≥–∞ (V)
    # current_battery_voltage –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Ä–∞–∑ –Ω–∞ —Å–µ–∫—É–Ω–¥—É –≤ Main Loop
    voltage_display = "----" if current_battery_voltage <= 0.5 else f"{current_battery_voltage:.1f}"
    voltage_text = f"{voltage_display}V"
    oled_obj.stretched_text(voltage_text, Settings.SP_SCR_VOLTAGE_X, Settings.SP_SCR_VOLTAGE_Y,
                           Settings.SP_SCR_VOLTAGE_FONT_SIZE, Settings.SP_SCR_VOLTAGE_FONT_SIZE)

    # 3. –û–±–µ—Ä—Ç–∏ –¥–≤–∏–≥—É–Ω–∞ (RPM)
    rpm_display = "----" if rpm_val <= 0 else f"{int(rpm_val):4d}"
    rpm_text = f"{rpm_display}RPM"
    oled_obj.stretched_text(rpm_text, Settings.SP_SCR_RPM_X, Settings.SP_SCR_RPM_Y,
                           Settings.SP_SCR_RPM_FONT_SIZE, Settings.SP_SCR_RPM_FONT_SIZE)

    # 4. –ó–∞–ª–∏—à–æ–∫ –ø–∞–ª–∏–≤–∞ (L)
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Ö—ñ–¥–Ω–∏–π –≤—ñ–¥—Å–æ—Ç–æ–∫. –Ø–∫—â–æ –≤—ñ–Ω 0 –∞–±–æ (—è–∫—â–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –≤—ñ–Ω 100)
    # –¥–æ–¥–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, —á–∏ –≤–∑–∞–≥–∞–ª—ñ –¥–∞–Ω—ñ –≥–æ—Ç–æ–≤—ñ.
    if fuel_percent_val <= 0.9:
        fuel_display = "--"
    else:
        fuel_L = (fuel_percent_val / 100) * Settings.FUEL_TANK_CAPACITY_L
        fuel_display = f"{int(fuel_L):2d}"

    fuel_text = f"{fuel_display}L"
    oled_obj.stretched_text(fuel_text, Settings.SP_SCR_FUEL_X, Settings.SP_SCR_FUEL_Y,
                           Settings.SP_SCR_FUEL_FONT_SIZE, Settings.SP_SCR_FUEL_FONT_SIZE)

    # 5. –ß–∞—Å –≤–ø–æ—Ä—Å–∫—É–≤–∞–Ω–Ω—è
    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–∏—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    inj_us = get_current_inj_period_atomic()
    current_ms = inj_us / 1000.0
    # –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è (–ó–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è)
    # –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç 0.2 –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ 20% –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    # –¶–µ –ø—Ä–∏–±–µ—Ä–µ "–¥—Ä–∏–∂–∞–Ω–Ω—è", –∞–ª–µ –∑–∞–ª–∏—à–∏—Ç—å —à–≤–∏–¥–∫—É —Ä–µ–∞–∫—Ü—ñ—é –Ω–∞ –≥–∞–∑.
    if current_ms > 0:
        if avg_inj_ms == 0:
            avg_inj_ms = current_ms  # –ü–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫
        else:
            avg_inj_ms = (avg_inj_ms * 0.8) + (current_ms * 0.2)
    else:
        avg_inj_ms = 0.0
    # –í–∏–≤—ñ–¥ –Ω–∞ –µ–∫—Ä–∞–Ω
    inj_display = "----" if avg_inj_ms <= 0 else f"{avg_inj_ms:.2f}"
    oled_obj.stretched_text(f"{inj_display}MS", Settings.SP_SCR_INJ_X, Settings.SP_SCR_INJ_Y, Settings.SP_SCR_INJ_FONT_SIZE, 2, 1)

    # 6. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Ñ–∞–π–ª–æ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫ (—è–∫—â–æ —î)
    if file_error_count > 0:
        error_display_text = f"FE:{file_error_count}"
        text_w = len(error_display_text) * 8
        oled_obj.text(error_display_text, 128 - text_w - 4, 0, 1)

    oled_obj.show()


def calculate_and_display(interval_sec=1):
    """
    –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª –ª–æ–≥—ñ–∫–∏, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ:
    –∑–±—ñ—Ä –¥–∞–Ω–∏—Ö, —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏, –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Å–ø–ª–µ—è.
    """
    global trip_fuel_consumed_L, trip_distance_travelled_km, persistent_trip_fuel_L, persistent_trip_distance_km
    global low_fuel_display_state, low_fuel_last_state_change_time_ms
    global is_engine_running_stable
    global wdt, current_display_mode, special_screen_active_time_ms

    global button_trip_reset_triggered, button_special_screen_triggered, button_special_screen_beep_played
    global button_press_timer_start, current_error_display_index, last_error_cycle_time_ms

    if wdt:
        wdt.feed() # "–ì–æ–¥—É—î–º–æ" Watchdog, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é.

    # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ TRIP.
    if trip_fuel_consumed_L > Settings.MAX_TRIP_LITERS or trip_distance_travelled_km > Settings.MAX_TRIP_DISTANCE:
        trip_fuel_consumed_L = 0.0
        trip_distance_travelled_km = 0.0

    global total_pulse_time_us, vss_pulse_count
    global blink_on, last_blink_toggle_time_ms
    global active_errors, current_error_display_index, last_error_cycle_time_ms
    global sensor_alarm_active, alarm_phase, alarm_phase_start_time_ms
    global current_speaker_freq, current_speaker_duty
    global _queued_errors_for_next_cycle
    global last_persistent_save_time_ms
    global file_error_count

    current_time_ms = time.ticks_ms()

    # 1. –ê—Ç–æ–º–∞—Ä–Ω–µ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è IRQ –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤.
    # –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è, —â–æ–± –±–µ–∑–ø–µ—á–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ, —è–∫—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤ IRQ.
    state = disable_irq()
    pulses_to_process = vss_pulse_count
    pulse_time_to_process_us = total_pulse_time_us
    vss_pulse_count = 0        # –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø—ñ—Å–ª—è –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è.
    total_pulse_time_us = 0
    enable_irq(state)          # –ó–Ω–æ–≤—É –≤–º–∏–∫–∞—î–º–æ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è.

    # 2. –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö.
    # 2.1. –í—ñ–¥—Å—Ç–∞–Ω—å, –ø—Ä–æ–π–¥–µ–Ω–∞ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª.
    distance_km_current_interval = pulses_to_process / Settings.VSS_IMPULSES_PER_KM

    # 2.2. –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–∞—Å—É —ñ–º–ø—É–ª—å—Å—É —Ñ–æ—Ä—Å—É–Ω–∫–∏ –≤ –ª—ñ—Ç—Ä–∏.
    # ML_PER_MIN -> L_PER_US
    FUEL_RATE_L_PER_US = Settings.INJ_FLOW_RATE_ML_PER_MIN / (1000 * 60 * 1_000_000)

    # 2.3. –û–±'—î–º –ø–∞–ª–∏–≤–∞, —Å–ø–æ–∂–∏—Ç–∏–π –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª.
    # –ü–∞–ª–∏–≤–æ —Ä–∞—Ö—É—î—Ç—å—Å—è –ª–∏—à–µ, —è–∫—â–æ –¥–≤–∏–≥—É–Ω –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ.
    volume_L_current_interval = pulse_time_to_process_us * FUEL_RATE_L_PER_US if is_engine_running_stable else 0.0

    # 2.4. –ü–æ—Ç–æ—á–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥).
    current_speed_kmh = (distance_km_current_interval / (interval_sec / 3600.0)) if interval_sec > 0 else 0.0

    # 2.5. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ "—Å–∏—Ä–æ—ó" –≤–∏—Ç—Ä–∞—Ç–∏ –¥–ª—è –±—É—Ñ–µ—Ä–∞ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è (L/H –∞–±–æ L/100KM).
    raw_volume_l_per_h = volume_L_current_interval / (interval_sec / 3600.0) if interval_sec > 0 else 0.0

    # –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ –º–æ–∂–Ω–∞ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ L/100KM.
    can_show_l100km = (current_speed_kmh >= Settings.MIN_SPEED_FOR_L100KM_KMH) and \
                      (trip_distance_travelled_km >= Settings.MIN_DISTANCE_FOR_L100KM_KM)

    temp_raw_val = 0.0
    if can_show_l100km:
        # L/100KM = (–ª—ñ—Ç—Ä–∏ / –∫—ñ–ª–æ–º–µ—Ç—Ä–∏) * 100
        temp_raw_val = (volume_L_current_interval / distance_km_current_interval) * 100.0 if distance_km_current_interval > 0.0001 else 0.0
    else:
        temp_raw_val = raw_volume_l_per_h

    # --- –õ–û–ì–Ü–ö–ê –ó–ì–õ–ê–î–ñ–£–í–ê–ù–ù–Ø –û–°–ù–û–í–ù–û–ì–û –ü–û–ö–ê–ó–ù–ò–ö–ê ---
    global main_val_buffer, last_display_unit
    current_unit = "L/100KM" if can_show_l100km else "L/H"

    # –Ø–∫—â–æ –æ–¥–∏–Ω–∏—Ü—ñ –≤–∏–º—ñ—Ä—É –ø–µ—Ä–µ–º–∫–Ω—É–ª–∏—Å—è, –æ—á–∏—â–∞—î–º–æ –±—É—Ñ–µ—Ä –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ "–∫–∞—à—ñ".
    if current_unit != last_display_unit:
        main_val_buffer = [temp_raw_val] * Settings.MAIN_VAL_BUFFER_SIZE
        last_display_unit = current_unit

    # –î–æ–¥–∞—î–º–æ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ –±—É—Ñ–µ—Ä–∞ —Ç–∞ –æ–±—á–∏—Å–ª—é—î–º–æ –∑–≥–ª–∞–¥–∂–µ–Ω–µ —Å–µ—Ä–µ–¥–Ω—î.
    main_val_buffer.pop(0)
    main_val_buffer.append(temp_raw_val)
    smoothed_val = sum(main_val_buffer) / len(main_val_buffer)

    # 3. –ù–∞–∫–æ–ø–∏—á–µ–Ω–Ω—è —ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–æ—ó–∑–¥–æ–∫.
    # TRIP –Ω–∞–∫–æ–ø–∏—á—É—î—Ç—å—Å—è, —è–∫—â–æ –¥–≤–∏–≥—É–Ω —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π.
    trip_fuel_consumed_L += volume_L_current_interval
    trip_distance_travelled_km += distance_km_current_interval

    # PERS –Ω–∞–∫–æ–ø–∏—á—É—î—Ç—å—Å—è –ª–∏—à–µ, —è–∫—â–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å –≤–∏—â–µ –ø–µ–≤–Ω–æ–≥–æ –ø–æ—Ä–æ–≥—É.
    if current_speed_kmh >= Settings.MIN_SPEED_FOR_PERS_COUNT_KMH:
        persistent_trip_fuel_L += volume_L_current_interval
        persistent_trip_distance_km += distance_km_current_interval

    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å–∫–∏–¥–∞–Ω–Ω—è PERS —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.
    reset_persistent_trip()
    save_persistent_data()

    # 4. –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ (–Ü–ì–ù–û–†–£–Ñ–¢–¨–°–Ø, –Ø–ö–©–û –ê–ö–¢–ò–í–ù–ò–ô –°–ü–ï–¶–Ü–ê–õ–¨–ù–ò–ô –ï–ö–†–ê–ù).
    if current_display_mode != "SPECIAL_SCREEN":
        # 4.1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è –ø–∞–ª–∏–≤–∞ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö –¥–∞—Ç—á–∏–∫—ñ–≤.
        process_fuel_smoothing()
        real_sensor_errors = check_errors()

        # 4.2. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—ñ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫.
        has_critical_errors = any(err['text'] in ALL_SOUND_TRIGGERING_ERROR_TEXTS for err in real_sensor_errors)
        has_low_fuel_error = any(err['text'] == Icons.ERROR_ICONS['LOW_FUEL']['text'] for err in real_sensor_errors)

        errors_to_show_based_on_sensors = []
        if has_critical_errors:
            errors_to_show_based_on_sensors = [err for err in real_sensor_errors if err['text'] in ALL_SOUND_TRIGGERING_ERROR_TEXTS]
            if 'WARNING' in Icons.ERROR_ICONS:
                errors_to_show_based_on_sensors.append(Icons.ERROR_ICONS['WARNING'])
        elif has_low_fuel_error:
            errors_to_show_based_on_sensors = [Icons.ERROR_ICONS['LOW_FUEL']]
        else:
            errors_to_show_based_on_sensors = [Icons.ERROR_ICONS['NONE']]

        # 4.3. –õ–û–ì–Ü–ö–ê –§–Ü–ö–°–ê–¶–Ü–á –¢–ê –ß–ï–†–ì–ò –ü–û–ú–ò–õ–û–ö
        current_severity = _get_error_severity_level(active_errors)
        new_severity = _get_error_severity_level(errors_to_show_based_on_sensors)

        # –ü—Ä–∏–±—Ä–∞—Ç–∏ –Ω–µ–≥–∞–π–Ω–∏–π –≤–∏—Ö—ñ–¥ –ø—Ä–∏ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—ñ –ø–æ–º–∏–ª–æ–∫ (new_severity == 0)
        should_switch_immediately = (new_severity > current_severity) or \
                                    (current_severity == 0 and new_severity > 0)

        if should_switch_immediately:
            if active_errors != errors_to_show_based_on_sensors:
                active_errors = errors_to_show_based_on_sensors[:]
                _queued_errors_for_next_cycle = []
                current_error_display_index = 0
                last_error_cycle_time_ms = current_time_ms
                low_fuel_display_state = 0
                low_fuel_last_state_change_time_ms = current_time_ms
        elif active_errors != errors_to_show_based_on_sensors:
            if errors_to_show_based_on_sensors != _queued_errors_for_next_cycle:
                _queued_errors_for_next_cycle = errors_to_show_based_on_sensors[:]

        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ü–∏–∫–ª—É
        time_since_last_switch = time.ticks_diff(current_time_ms, last_error_cycle_time_ms)
        is_cycle_complete = (time_since_last_switch >= Settings.ERROR_DISPLAY_CYCLE_MS) and \
                            (current_error_display_index >= len(active_errors) - 1)

        # –Ø–∫—â–æ –ø–æ–º–∏–ª–æ–∫ –±—ñ–ª—å—à–µ –Ω–µ–º–∞—î, –º–∏ —á–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ü–∏–∫–ª—É, –ø–µ—Ä—à –Ω—ñ–∂ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ NONE
        if is_cycle_complete:
            if _queued_errors_for_next_cycle:
                active_errors = _queued_errors_for_next_cycle[:]
                _queued_errors_for_next_cycle = []
                current_error_display_index = 0
                last_error_cycle_time_ms = current_time_ms
            elif errors_to_show_based_on_sensors == [Icons.ERROR_ICONS['NONE']] and active_errors != [Icons.ERROR_ICONS['NONE']]:
                active_errors = [Icons.ERROR_ICONS['NONE']]
                current_error_display_index = 0

        # –û–Ω–æ–≤–ª—é—î–º–æ current_display_mode –¢–Ü–õ–¨–ö–ò –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ê–ö–¢–£–ê–õ–¨–ù–û –≤—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∏—Ö (active_errors)
        if active_errors == [Icons.ERROR_ICONS['NONE']]:
            current_display_mode = "MAIN"
            sensor_alarm_active = False
        elif any(err['text'] == Icons.ERROR_ICONS['LOW_FUEL']['text'] for err in active_errors) and not has_critical_errors:
            current_display_mode = "LOW_FUEL_CYCLE"
            sensor_alarm_active = False
        else:
            current_display_mode = "ERROR_CYCLE"
            # –ó–≤—É–∫ –ø—Ä–∞—Ü—é—î –ø–æ –∞–∫—Ç–∏–≤–Ω—ñ–π –ø–æ–º–∏–ª—Ü—ñ
            if pwm_speaker:
                if _get_error_severity_level(active_errors) == 3:
                    if not sensor_alarm_active:
                        sensor_alarm_active = True
                        alarm_phase = 0; alarm_phase_start_time_ms = 0
                        if pwm_speaker.freq() != Settings.ALARM_SEQUENCE[0][1]:
                             pwm_speaker.freq(Settings.ALARM_SEQUENCE[0][1])
                        pwm_speaker.duty_u16(32768)
                else:
                    sensor_alarm_active = False
    # 4.4. –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ó–í–£–ö–û–ú —Ç–∞ –ë–õ–ò–ú–ê–ù–ù–Ø–ú (–∑–∞ –º–µ–∂–∞–º–∏ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É).
    manage_sensor_alarm() # –ö–µ—Ä—É—î–º–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—é –∑–≤—É–∫–æ–≤–∏—Ö —Å–∏–≥–Ω–∞–ª—ñ–≤.

    # –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –±–ª–∏–º–∞–Ω–Ω—è –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤.
    if time.ticks_diff(current_time_ms, last_blink_toggle_time_ms) >= Settings.BLINK_INTERVAL_MS:
        blink_on = not blink_on
        last_blink_toggle_time_ms = current_time_ms

    # 4.5. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ OLED –¥–∏—Å–ø–ª–µ—ó.
    if oled_status != "OK" or oled is None:
        return # –Ø–∫—â–æ OLED –Ω–µ –ø—Ä–∞—Ü—é—î, –Ω—ñ—á–æ–≥–æ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ.

    # --- –õ–û–ì–Ü–ö–ê –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –ù–ê –û–°–ù–û–í–Ü current_display_mode ---
    if current_display_mode == "SPECIAL_SCREEN":
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∞—Å—É –¥–ª—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É.
        if time.ticks_diff(current_time_ms, special_screen_active_time_ms) >= Settings.SPECIAL_SCREEN_DISPLAY_DURATION_MS:
            # –ß–∞—Å —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É –≤–∏–π—à–æ–≤, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ä–µ–∂–∏–º—É.
            # –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ —î –ø–æ–º–∏–ª–∫–∏, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –µ–∫—Ä–∞–Ω –ø–æ–º–∏–ª–æ–∫ –∞–±–æ –Ω–∞ –≥–æ–ª–æ–≤–Ω–∏–π.
            temp_errors = check_errors() # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ–º–∏–ª–∫–∏.
            if temp_errors != [Icons.ERROR_ICONS['NONE']] and any(err['text'] in ALL_SOUND_TRIGGERING_ERROR_TEXTS for err in temp_errors):
                current_display_mode = "ERROR_CYCLE"
            elif any(err['text'] == Icons.ERROR_ICONS['LOW_FUEL']['text'] for err in temp_errors):
                current_display_mode = "LOW_FUEL_CYCLE"
            else:
                current_display_mode = "MAIN"
            # –°–∫–∏–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –æ–±—Ä–æ–±–∫–∏ –∫–Ω–æ–ø–∫–∏, —â–æ–± –≤–æ–Ω–∞ –∑–Ω–æ–≤—É —Ä–µ–∞–≥—É–≤–∞–ª–∞.
            button_trip_reset_triggered = False
            button_special_screen_triggered = False
            button_special_screen_beep_played = False
            # –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É —Å–∫–∏–¥–∞–Ω–Ω—é, —è–∫—â–æ –∫–Ω–æ–ø–∫–∞ –≤—Å–µ —â–µ —É—Ç—Ä–∏–º—É—î—Ç—å—Å—è.
            if button_press_timer_start != 0:
                button_press_timer_start = 0

        else:
            # –Ø–∫—â–æ —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–Ω–∏–π, –º–∞–ª—é—î–º–æ –π–æ–≥–æ.
            draw_special_screen(oled, current_speed_kmh, get_current_rpm_atomic(), last_smoothed_fuel_percent)
            return # –í–∏—Ö–æ–¥–∏–º–æ, –æ—Å–∫—ñ–ª—å–∫–∏ –µ–∫—Ä–∞–Ω –≤–∂–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ.

    elif current_display_mode == "LOW_FUEL_CYCLE":
        # –ú–∏ –ø–µ—Ä–µ–±—É–≤–∞—î–º–æ –≤ —Å—Ç–∞–Ω—ñ "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞", —â–æ –º–∞—î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π —Ü–∏–∫–ª –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
        time_since_low_fuel_state_change = time.ticks_diff(current_time_ms, low_fuel_last_state_change_time_ms)

        if low_fuel_display_state == 0: # –°—Ç–∞–Ω: –ü–æ–∫–∞–∑—É—î–º–æ —ñ–∫–æ–Ω–∫—É "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞".
            if time_since_low_fuel_state_change >= Settings.LOW_FUEL_DISPLAY_DURATION_MS:
                low_fuel_display_state = 1 # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –ø–æ–∫–∞–∑—É –≥–æ–ª–æ–≤–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É.
                low_fuel_last_state_change_time_ms = current_time_ms

            oled.fill(0) # –û—á–∏—â–∞—î–º–æ –¥–∏—Å–ø–ª–µ–π.
            icon_to_draw = Icons.ERROR_ICONS['LOW_FUEL']
            if icon_to_draw['icon'] is not None:
                icon_fb = framebuf.FrameBuffer(icon_to_draw['icon'], icon_to_draw['width'], icon_to_draw['height'], framebuf.MONO_HLSB)
                oled.blit(icon_fb, icon_to_draw['icon_pos'][0], icon_to_draw['icon_pos'][1])
                # –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                coords = icon_to_draw.get('icon_pos', (3, 3))
                ix, iy = coords[0], coords[1]
                # –ú–∞–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É
                oled.blit(icon_fb, ix, iy)
                # –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ä–µ–∞–ª—å–Ω—ñ –ª—ñ—Ç—Ä–∏
                f_L_real = (last_smoothed_fuel_percent / 100) * Settings.FUEL_TANK_CAPACITY_L
                fuel_num = int(f_L_real)
                # –õ–æ–≥—ñ–∫–∞ –≤–∏–±–æ—Ä—É —Ç–µ–∫—Å—Ç—É
                if fuel_num > 9:
                    fuel_txt = ">"
                else:
                    fuel_txt = f"{fuel_num}L"
                # –í–∏–≤—ñ–¥ –Ω–∞ –µ–∫—Ä–∞–Ω
                ix, iy = icon_to_draw.get('icon_pos', (3, 3))
                # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ü–µ–Ω—Ç—Ä—É
                if fuel_txt == ">":
                    text_x = ix + 38 # –î–ª—è —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è >
                else:
                    text_x = ix + 29 # –î–ª—è —Ü–∏—Ñ—Ä–∏ –∑ L
                oled.large_text(fuel_txt, text_x, iy + 60, 3, 0)
            if file_error_count > 0: # –î–æ–¥–∞—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ —Ñ–∞–π–ª—É, —è–∫—â–æ —î.
                error_display_text = f"FE:{file_error_count}"
                text_w = len(error_display_text) * 8
                oled.text(error_display_text, 128 - text_w - 4, 0, 1)
            oled.show()

        elif low_fuel_display_state == 1:  # –°—Ç–∞–Ω: –ü–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω.
            if time_since_low_fuel_state_change >= Settings.LOW_FUEL_MAIN_SCREEN_DURATION_MS:
                low_fuel_display_state = 0  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞–∑–∞–¥ –¥–æ –ø–æ–∫–∞–∑—É —ñ–∫–æ–Ω–∫–∏ "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞".
                low_fuel_last_state_change_time_ms = current_time_ms

            oled.fill(0)
            draw_main_screen( # –ú–∞–ª—é—î–º–æ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω.
                oled,
                distance_km_current_interval,
                volume_L_current_interval,
                current_speed_kmh,
                interval_sec,
                display_value=smoothed_val
            )
            # –ü–æ–∫–∞–∑—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Ñ–∞–π–ª–æ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫ —Ç–∞–∫–æ–∂ –Ω–∞ –≥–æ–ª–æ–≤–Ω–æ–º—É –µ–∫—Ä–∞–Ω—ñ.
            if file_error_count > 0:
                error_display_text = f"FE:{file_error_count}"
                text_w = len(error_display_text) * 8
                oled.text(error_display_text, 128 - text_w - 4, 0, 1)

            oled.show()
        return  # –í–∞–∂–ª–∏–≤–æ: –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó, –æ—Å–∫—ñ–ª—å–∫–∏ –ª–æ–≥—ñ–∫–∞ "–ú–∞–ª–æ –ø–∞–ª–∏–≤–∞" –≤–∂–µ –≤—Å–µ –Ω–∞–º–∞–ª—é–≤–∞–ª–∞.

    elif current_display_mode == "MAIN":
        # –Ø–∫—â–æ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫, –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω.
        oled.fill(0)
        draw_main_screen(oled, distance_km_current_interval, volume_L_current_interval, current_speed_kmh, interval_sec,
        display_value=smoothed_val)
        oled.show()
        return

    elif current_display_mode == "ERROR_CYCLE":
        # –Ø–∫—â–æ —î —ñ–Ω—à—ñ (–∫—Ä–∏—Ç–∏—á–Ω—ñ) –ø–æ–º–∏–ª–∫–∏, —Ü–∏–∫–ª—ñ—á–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —ó—Ö —ñ–∫–æ–Ω–∫–∏.
        # –ü–µ—Ä–µ–∫–æ–Ω–∞—î–º–æ—Å—è, —â–æ —ñ–Ω–¥–µ–∫—Å –Ω–µ –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ –º–µ–∂—ñ —Å–ø–∏—Å–∫—É.
        if current_error_display_index >= len(active_errors):
            current_error_display_index = 0

        error_to_display = active_errors[current_error_display_index]
        oled.fill(0)

        # –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ—Å—è –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏ –≤ —Å–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª.
        if time.ticks_diff(current_time_ms, last_error_cycle_time_ms) >= Settings.ERROR_DISPLAY_CYCLE_MS:
            current_error_display_index = (current_error_display_index + 1) % len(active_errors)
            last_error_cycle_time_ms = current_time_ms

        # –ú–∞–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É –ø–æ—Ç–æ—á–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏.
        if error_to_display['icon'] is not None:
            icon_fb = framebuf.FrameBuffer(error_to_display['icon'], error_to_display['width'], error_to_display['height'], framebuf.MONO_HLSB)
            oled.blit(icon_fb, error_to_display['icon_pos'][0], error_to_display['icon_pos'][1])

        # –î–æ–¥–∞—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ —Ñ–∞–π–ª—É, —è–∫—â–æ —î.
        if file_error_count > 0:
            error_display_text = f"FE:{file_error_count}"
            text_w = len(error_display_text) * 8
            oled.text(error_display_text, 128 - text_w - 4, 0, 1)

        oled.show()

# -------------------------------------------------------------------------
# 9. –ì–û–õ–û–í–ù–ò–ô –¶–ò–ö–õ (MAIN LOOP)
#    –ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–π —Ü–∏–∫–ª, —â–æ –±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω–æ –≤–∏–∫–æ–Ω—É—î –æ—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø—Ä–æ–≥—Ä–∞–º–∏.
# -------------------------------------------------------------------------

print("‚úÖ –ë–æ—Ä—Ç–æ–≤–∏–π –ö–æ–º–ø'—é—Ç–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ: Audi 80 Mono Motronic v1.2.3")
while True:
    current_time_ms = time.ticks_ms()

    # –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–ø—Ä—É–≥—É —Ä–∞–∑ –Ω–∞ —Å–µ–∫—É–Ω–¥—É
    if time.ticks_diff(current_time_ms, last_voltage_update_time_ms) > 1000:
        update_voltage_correction()
        last_voltage_update_time_ms = current_time_ms

    # --- –ë–õ–û–ö –ü–ï–†–ï–í–Ü–†–ö–ò –ó–£–ü–ò–ù–ö–ò –î–í–ò–ì–£–ù–ê ---
    # –Ø–∫—â–æ –≤—ñ–¥ —Ñ–æ—Ä—Å—É–Ω–∫–∏ –Ω–µ–º–∞—î —Å–∏–≥–Ω–∞–ª—É –±—ñ–ª—å—à–µ –∑–∞–¥–∞–Ω–æ–≥–æ —á–∞—Å—É (ENGINE_STOP_TIMEOUT_MS),
    # –≤–≤–∞–∂–∞—î–º–æ, —â–æ –¥–≤–∏–≥—É–Ω –∑–∞–≥–ª—É—Ö.
    if time.ticks_diff(current_time_ms, last_inj_activity_time_ms) > Settings.ENGINE_STOP_TIMEOUT_MS:
        rpm = 0
        is_engine_running = False
        is_engine_running_stable = False
        # –í–ê–ñ–õ–ò–í–û: —Å–∫–∏–¥–∞—î–º–æ —á–∞—Å —Å—Ç–∞—Ä—Ç—É –¥–≤–∏–≥—É–Ω–∞, —â–æ–± –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∏—Å–∫—É –º–∞—Å–ª–∞
        # –∫–æ—Ä–µ–∫—Ç–Ω–æ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É.
        engine_start_time_ms = 0

    # --- –ë–õ–û–ö –û–ë–†–û–ë–ö–ò –ö–ù–û–ü–ö–ò (–°–∫–∏–¥–∞–Ω–Ω—è TRIP / –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –µ–∫—Ä–∞–Ω) ---
    is_button_down = (RESET_BUTTON_PIN.value() == 0) # –ß–∏—Ç–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –∫–Ω–æ–ø–∫–∏.
    # current_time_ms –≤–∂–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ü–∏–∫–ª—É while True.

    if is_button_down:
        if button_press_timer_start == 0:
            # –ö–Ω–æ–ø–∫–∞ —â–æ–π–Ω–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞. –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–∞–π–º–µ—Ä.
            button_press_timer_start = current_time_ms
            button_trip_reset_candidate = False # –°–∫–∏–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞ –ø–æ—á–∞—Ç–∫—É –Ω–æ–≤–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è.
        else:
            # –ö–Ω–æ–ø–∫–∞ —É—Ç—Ä–∏–º—É—î—Ç—å—Å—è, –æ–±—á–∏—Å–ª—é—î–º–æ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —É—Ç—Ä–∏–º–∞–Ω–Ω—è.
            hold_duration = time.ticks_diff(current_time_ms, button_press_timer_start)

            # 1. –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É (5 —Å–µ–∫—É–Ω–¥ —É—Ç—Ä–∏–º–∞–Ω–Ω—è).
            # –¶—è –¥—ñ—è –º–∞—î –Ω–∞–π–≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç.
            if hold_duration >= Settings.BUTTON_SPECIAL_SCREEN_HOLD_MS and not button_special_screen_triggered:
                if not button_special_screen_beep_played:
                    play_special_screen_beeps() # –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–¥–≤—ñ–π–Ω–∏–π —Å–∏–≥–Ω–∞–ª.
                    button_special_screen_beep_played = True

                # –ê–∫—Ç–∏–≤–∞—Ü—ñ—è —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω—É.
                current_display_mode = "SPECIAL_SCREEN"
                special_screen_active_time_ms = current_time_ms
                button_special_screen_triggered = True
                button_trip_reset_candidate = False # –í–ê–ñ–õ–ò–í–û: —è–∫—â–æ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω, —Å–∫–∏–¥–∞–Ω–Ω—è TRIP —Å–∫–∞—Å–æ–≤—É—î—Ç—å—Å—è.

            # 2. –õ–æ–≥—ñ–∫–∞ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ–≥–æ —Å–∫–∏–¥–∞–Ω–Ω—è TRIP (–º—ñ–∂ 2 —Ç–∞ 5 —Å–µ–∫—É–Ω–¥–∞–º–∏ —É—Ç—Ä–∏–º–∞–Ω–Ω—è).
            # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ TRIP –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–∏–Ω—É—Ç–∏–π, —è–∫—â–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–ø—É—Å—Ç—è—Ç—å
            # —É "–≤—ñ–∫–Ω—ñ" –º—ñ–∂ 2 —Ç–∞ 5 —Å–µ–∫—É–Ω–¥–∞–º–∏ —É—Ç—Ä–∏–º–∞–Ω–Ω—è, —ñ —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω —â–µ –Ω–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π.
            elif hold_duration >= Settings.BUTTON_TRIP_RESET_HOLD_MS and \
                 hold_duration < Settings.BUTTON_SPECIAL_SCREEN_HOLD_MS and \
                 not button_special_screen_triggered:

                button_trip_reset_candidate = True # –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ TRIP —î –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –Ω–∞ —Å–∫–∏–¥–∞–Ω–Ω—è.

                if not button_trip_ready_beep_played:  # –Ø–∫—â–æ –∑–≤—É–∫ —â–µ –ù–ï –≥—Ä–∞–≤
                    play_single_beep(Settings.BUTTON_TRIP_READY_BEEP_FREQ, Settings.BUTTON_TRIP_READY_BEEP_DURATION_SEC)
                    button_trip_ready_beep_played = True  # ‚úÖ –ë–õ–û–ö–£–í–ê–ù–ù–Ø –ø–æ–≤—Ç–æ—Ä—ñ–≤

    else: # –ö–Ω–æ–ø–∫–∞ –≤—ñ–¥–ø—É—â–µ–Ω–∞.
        if button_press_timer_start != 0: # –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–Ω–æ–ø–∫–∞ –±—É–ª–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞ —Ä–∞–Ω—ñ—à–µ.
            button_trip_ready_beep_played = False  # –ì–æ—Ç—É—î–º–æ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è

            # --- –§–∞–∫—Ç–∏—á–Ω–µ —Å–∫–∏–¥–∞–Ω–Ω—è TRIP –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Ç—É—Ç, –ø—Ä–∏ –≤—ñ–¥–ø—É—Å–∫–∞–Ω–Ω—ñ –∫–Ω–æ–ø–∫–∏. ---
            # –£–º–æ–≤–∞:
            # 1. `button_trip_reset_candidate` —î True (–æ–∑–Ω–∞—á–∞—î, —â–æ –∫–Ω–æ–ø–∫—É —Ç—Ä–∏–º–∞–ª–∏ –º—ñ–∂ 2 —ñ 5 —Å–µ–∫—É–Ω–¥–∞–º–∏).
            # 2. –°–ø–µ—Ü-–µ–∫—Ä–∞–Ω –ù–ï –±—É–≤ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π (`button_special_screen_triggered` False).
            if button_trip_reset_candidate and not button_special_screen_triggered:
                trip_fuel_consumed_L = 0.0
                trip_distance_travelled_km = 0.0
                print("üîÑ TRIP RESET by button")
                play_single_beep(Settings.BUTTON_TRIP_RESET_BEEP_FREQ, Settings.BUTTON_TRIP_RESET_BEEP_DURATION_SEC)

            # –°–∫–∏–¥–∞—î–º–æ –≤—Å—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ —Ç–∞ —Ç–∞–π–º–µ—Ä–∏ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è.
            button_press_timer_start = 0
            button_special_screen_triggered = False
            button_special_screen_beep_played = False
            button_trip_reset_candidate = False # –°–∫–∏–¥–∞—î–º–æ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è.
            # –Ø–∫—â–æ —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤—É–≤–∞–≤—Å—è –ø–æ 5-—Å–µ–∫—É–Ω–¥–Ω–æ–º—É —É—Ç—Ä–∏–º–∞–Ω–Ω—é, –≤—ñ–Ω –∑–∞–ª–∏—à–∏—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–∏–º –Ω–∞ 15 —Å–µ–∫—É–Ω–¥.
            # –Ø–∫—â–æ –∫–Ω–æ–ø–∫–∞ –≤—ñ–¥–ø—É—â–µ–Ω–∞ –¥–æ 5 —Å–µ–∫—É–Ω–¥, —Ç–æ —Å–ø–µ—Ü-–µ–∫—Ä–∞–Ω –Ω–µ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è.

    # --- –û–°–ù–û–í–ù–ò–ô –ë–õ–û–ö –í–ò–ö–û–ù–ê–ù–ù–Ø –õ–û–ì–Ü–ö–ò ---
    try:
        current_time = time.ticks_ms()
        # –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª —á–∞—Å—É, —â–æ –º–∏–Ω—É–≤ –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.
        actual_interval_sec = time.ticks_diff(current_time, last_display_update_time) / 1000.0
        if actual_interval_sec == 0: # –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –¥—ñ–ª–µ–Ω–Ω—é –Ω–∞ –Ω—É–ª—å –∞–±–æ –¥—É–∂–µ –º–∞–ª–∏–º —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∞–º.
            actual_interval_sec = Settings.UPDATE_INTERVAL_SEC

        calculate_and_display(actual_interval_sec) # –í–∏–∫–æ–Ω—É—î–º–æ –≤—Å—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Å–ø–ª–µ—è.

        last_display_update_time = current_time # –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Å–ø–ª–µ—è.
        time.sleep(Settings.UPDATE_INTERVAL_SEC) # –ü–∞—É–∑–∞ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ü–∏–∫–ª—É.
    except Exception as e:
        # –û–±—Ä–æ–±–∫–∞ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫ –≤ –≥–æ–ª–æ–≤–Ω–æ–º—É —Ü–∏–∫–ª—ñ.
        print(f"Loop Error: {e}")
        # –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ "LOOP ERR" –Ω–∞ –¥–∏—Å–ø–ª–µ—ó.
        if oled_status == "OK" and oled:
            oled.fill(0)
            oled.large_text(
                "LOOP ERR",
                Settings.LOOP_ERROR_X_POS,
                Settings.LOOP_ERROR_Y_POS,
                Settings.LOOP_ERROR_TEXT_SIZE,
                1
            )
            oled.show()
        # –í–∏–º–∏–∫–∞—î–º–æ –¥–∏–Ω–∞–º—ñ–∫, —è–∫—â–æ –≤—ñ–Ω –±—É–≤ –∞–∫—Ç–∏–≤–Ω–∏–π.
        if pwm_speaker:
            pwm_speaker.duty_u16(0)
            current_speaker_duty = 0
        time.sleep(5) # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ü–∏–∫–ª—É.
